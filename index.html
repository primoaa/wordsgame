<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ - ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ ŸÜÿ®ÿßÿ™ ÿ¨ŸÖÿßÿØ ÿ®ŸÑÿßÿØ</title>
    <meta name="description" content="ŸÑÿπÿ®ÿ© ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© - ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ ŸÜÿ®ÿßÿ™ ÿ¨ŸÖÿßÿØ ÿ®ŸÑÿßÿØ - ÿßŸÑÿπÿ® ŸÖÿπ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ ÿ£ŸàŸÜŸÑÿßŸäŸÜ">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mode-styles.css">
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-blue: #4361ee;
            --accent-purple: #7209b7;
            --accent-pink: #f72585;
            --accent-green: #06d6a0;
            --accent-red: #ef233c;
            --accent-yellow: #ffd60a;
            --accent-orange: #fb8500;
            --accent-cyan: #00b4d8;
            --accent-lime: #84cc16;
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --border-radius: 20px;
            /* Phase Colors */
            --phase-speed: #4361ee;
            --phase-accuracy: #06d6a0;
            --phase-challenge: #f72585;
            --phase-current: var(--accent-blue);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, #0f0f23 100%);
            min-height: 100vh;
            color: var(--text-white);
        }

        /* Phase-based accent colors (Header, Borders, Accents only) */
        body[data-phase="speed"] {
            --phase-current: var(--phase-speed);
        }

        body[data-phase="accuracy"] {
            --phase-current: var(--phase-accuracy);
        }

        body[data-phase="challenge"] {
            --phase-current: var(--phase-challenge);
        }

        .phase-accent {
            color: var(--phase-current);
        }

        .phase-accent-border {
            border-color: var(--phase-current);
        }

        .phase-accent-bg {
            background-color: var(--phase-current);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Welcome Screen - New Design */
        #welcome-screen {
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            gap: 25px;
            padding: 20px;
            padding-top: 40px;
        }

        .welcome-header {
            margin-bottom: 10px;
        }

        .logo {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(0 4px 20px rgba(168, 85, 247, 0.4));
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-gray);
            margin-top: 8px;
            letter-spacing: 2px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--text-white);
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Mode Selection - 6 Modes */
        .mode-selection {
            width: 100%;
            max-width: 700px;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            .mode-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .mode-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }

        .mode-card {
            background: linear-gradient(145deg, rgba(88, 28, 135, 0.8), rgba(107, 33, 168, 0.6));
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-radius: 20px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .mode-card.selected {
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.4);
        }

        .mode-card.selected .mode-card-check {
            display: flex;
        }

        .mode-card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .mode-card-badge.new {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            }
        }

        .mode-card-icon {
            font-size: 3rem;
            margin: 10px 0;
        }

        .mode-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .mode-card-desc {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .mode-card-check {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            width: 25px;
            height: 25px;
            background: #22c55e;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Player Name Section */
        .player-name-section {
            width: 100%;
            max-width: 350px;
        }

        .input-group.compact {
            margin: 0;
        }

        .input-group.compact label {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .input-group.compact input {
            padding: 14px 18px;
            font-size: 1rem;
            text-align: center;
        }

        /* Welcome Actions */
        .welcome-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }



        .btn-large {
            flex: 1;
            min-width: 150px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-icon {
            font-size: 1.3rem;
        }

        /* Categories Preview - Compact */
        .categories-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            opacity: 0.8;
        }

        .category-badge {
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .logo {
                font-size: 2.2rem;
            }

            .mode-cards {
                grid-template-columns: 1fr;
            }

            .mode-card {
                padding: 15px 12px;
            }

            .mode-card-icon {
                font-size: 2.5rem;
            }

            .welcome-actions {
                flex-direction: column;
            }

            .btn-large {
                width: 100%;
            }

            .categories-preview {
                gap: 5px;
            }

            .category-badge {
                padding: 4px 8px;
                font-size: 0.65rem;
            }
        }

        /* More responsive styles */
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .letter-display,
            .timer-display {
                padding: 12px 25px;
            }

            .current-letter {
                font-size: 2.8rem;
            }

            .timer-value {
                font-size: 2.5rem;
            }

            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }

            .category-header {
                padding: 8px;
                font-size: 0.85rem;
            }

            .category-input {
                padding: 10px;
                font-size: 1.2rem;
            }

            .btn-stop {
                padding: 14px 35px;
                font-size: 1.2rem;
            }

            .phase-info {
                padding: 8px 15px;
            }
        }

        /* Buttons */
        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 15px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(67, 97, 238, 0.6);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--accent-red), #d90429);
            color: white;
            font-size: 1.4rem;
            padding: 18px 50px;
        }

        .btn-stop:hover {
            transform: scale(1.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Room Screen */
        #room-screen {
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .room-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 35px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .room-card h2 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.6rem;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-gray);
        }

        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 1.05rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .room-code {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 5px;
            color: var(--accent-blue);
            text-align: center;
            margin: 15px 0;
        }

        /* Waiting Screen */
        #waiting-screen {
            justify-content: center;
            align-items: center;
            gap: 30px;
            text-align: center;
        }

        .waiting-animation {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .waiting-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            animation: waitingBounce 1.4s ease-in-out infinite;
        }

        .waiting-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .waiting-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes waitingBounce {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Game Screen */
        #game-screen {
            gap: 15px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px 0;
        }

        .letter-display {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            padding: 15px 35px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .letter-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .current-letter {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1;
        }

        .timer-display {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 90px;
            height: 90px;
            background: rgba(26, 26, 46, 0.95);
            padding: 0;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 4px solid rgba(255, 255, 255, 0.15);
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Reset potentially inherited text styles */
            line-height: normal;
        }

        .timer-label {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin-bottom: 2px;
            opacity: 0.8;
        }

        .timer-value {
            font-size: 2.4rem;
            font-weight: 900;
            color: var(--text-white);
            line-height: 1;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Danger/Warning States will be applied to the PARENT .timer-display */
        .timer-display.warning {
            border-color: var(--accent-orange);
            box-shadow: 0 0 20px rgba(251, 133, 0, 0.4);
        }

        .timer-display.danger {
            background: rgba(239, 35, 60, 0.9);
            border-color: #ef233c;
            animation: dangerPulse 1s infinite;
            box-shadow: 0 0 30px rgba(239, 35, 60, 0.6);
        }

        .timer-display.danger .timer-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .timer-display.danger .timer-value {
            color: white;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        @keyframes dangerPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 35, 60, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 15px rgba(239, 35, 60, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 35, 60, 0);
            }
        }

        @keyframes pulse {

            /* Legacy pulse, keeping just in case */
            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* Phase Info Styles */
        .phase-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid var(--phase-current);
        }

        .mode-name {
            font-size: 1rem;
            font-weight: 700;
        }

        .phase-dots {
            font-size: 1.2rem;
            letter-spacing: 4px;
            color: var(--phase-current);
        }

        /* Locked STOP button */
        .btn-stop.locked {
            background: rgba(128, 128, 128, 0.3) !important;
            color: rgba(255, 255, 255, 0.4) !important;
            cursor: not-allowed;
            border: 2px dashed rgba(255, 255, 255, 0.2) !important;
        }

        .btn-stop.locked::before {
            content: 'üîí ';
        }

        /* Categories Grid - 9 categories in 3 rows */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 10px 0;
        }

        .category-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .category-card:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .category-header {
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .category-body {
            padding: 12px;
        }

        .category-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1rem;
            text-align: center;
        }

        .category-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
        }

        .category-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-size: 1.5rem;
        }

        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        /* Category Colors */
        .cat-boy-name .category-header {
            background: var(--accent-red);
        }

        .cat-girl-name .category-header {
            background: var(--accent-pink);
        }

        .cat-vegetable .category-header {
            background: var(--accent-green);
        }

        .cat-fruit .category-header {
            background: var(--accent-lime);
        }

        .cat-object .category-header {
            background: #6c757d;
        }

        .cat-animal .category-header {
            background: var(--accent-blue);
        }

        .cat-country .category-header {
            background: var(--accent-purple);
        }

        .cat-city .category-header {
            background: var(--accent-cyan);
        }

        .cat-job .category-header {
            background: var(--accent-orange);
        }

        /* Results Screen */
        #results-screen {
            align-items: center;
            gap: 25px;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .results-title {
            font-size: 2.2rem;
            color: var(--accent-yellow);
        }

        .winner-banner {
            background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
            color: var(--primary-bg);
            padding: 18px 35px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .results-container {
            width: 100%;
            max-width: 1000px;
        }

        .player-results {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-name {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .player-score {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-yellow);
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .answer-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
        }

        .answer-category {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .answer-value {
            font-size: 1rem;
            font-weight: 600;
            word-break: break-word;
        }

        .answer-value.correct {
            color: var(--accent-green);
        }

        .answer-value.wrong {
            color: var(--accent-red);
        }

        .answer-points {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* Results Screen */
        .results-container {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-result-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-result-card.winner {
            border-color: var(--accent-yellow);
            background: linear-gradient(180deg, rgba(255, 214, 10, 0.1), rgba(0, 0, 0, 0.3));
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-player-name {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .result-total-score {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent-yellow);
        }

        .answer-points.positive {
            color: var(--accent-green);
        }

        .winner-banner {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            color: var(--accent-yellow);
            text-shadow: 0 0 20px rgba(255, 214, 10, 0.5);
        }

        .results-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 20px;
        }

        /* AI Verification Loading */
        .ai-loading {
            text-align: center;
            padding: 30px;
        }

        .ai-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            border-radius: 50px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .toast.error {
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Friends System */
        .friends-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4);
            transition: all 0.3s ease;
        }

        .friends-toggle:hover {
            transform: scale(1.1);
        }

        .friends-toggle .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friends-sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 320px;
            height: 100vh;
            background: rgba(22, 33, 62, 0.98);
            backdrop-filter: blur(20px);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .friends-sidebar.open {
            left: 0;
        }

        .friends-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friends-header h3 {
            font-size: 1.3rem;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .friends-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .friends-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .friends-tab.active {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
        }

        .friends-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .add-friend-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-friend-section input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
        }

        .add-friend-section button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background: var(--accent-green);
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .friend-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .friend-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .friend-name {
            font-weight: 600;
        }

        .friend-status {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .friend-status.online {
            color: var(--accent-green);
        }

        .friend-actions {
            display: flex;
            gap: 8px;
        }

        .friend-actions button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-invite {
            background: var(--accent-green);
            color: white;
        }

        .btn-invite:hover {
            transform: scale(1.1);
        }

        .btn-accept {
            background: var(--accent-green);
            color: white;
        }

        .btn-reject {
            background: var(--accent-red);
            color: white;
        }

        .my-id-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .my-id-section label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .my-id-section .user-id {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            word-break: break-all;
            margin: 8px 0;
        }

        .my-id-section button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: var(--accent-blue);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Invite Modal */
        .invite-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .invite-modal.show {
            display: flex;
        }

        .invite-modal-content {
            background: var(--secondary-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.3s ease;
        }

        .invite-modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .invite-modal-content p {
            color: var(--text-gray);
            margin-bottom: 20px;
        }

        .invite-modal-content .invite-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .invite-waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-gray);
            margin-top: 15px;
        }

        .invite-waiting .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-gray);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }

            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .current-letter {
                font-size: 2.5rem;
            }

            .timer-value {
                font-size: 2rem;
            }

            .friends-sidebar {
                width: 100%;
                left: -100%;
            }

            .friends-toggle {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }

            .chat-panel {
                width: 100%;
                right: 0;
                border-radius: 20px 20px 0 0;
            }
        }

        /* Chat System */
        .chat-panel {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(22, 33, 62, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
        }

        .chat-panel.hidden {
            display: none;
        }

        .chat-header {
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 700;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message.me {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-message.friend {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-message .time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
            display: block;
        }

        .chat-typing {
            padding: 5px 15px;
            font-size: 0.8rem;
            color: var(--text-gray);
            font-style: italic;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
        }

        .chat-input-area input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        .chat-date-divider {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.75rem;
            margin: 10px 0;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            text-align: center;
            padding: 20px;
        }

        .chat-empty .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Chat button in friend card */
        .btn-chat {
            background: var(--accent-blue);
            color: white;
        }

        .btn-chat:hover {
            transform: scale(1.1);
        }

        .chat-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Debug Console Overlay */
        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.85);
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
            z-index: 10000;
            border-top: 2px solid #333;
            display: none;
            /* hidden by default, toggled via script or UI */
            pointer-events: none;
            /* Let clicks pass through if needed, but we might want interaction */
            pointer-events: auto;
        }

        #debug-console .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        #debug-console .log-error {
            color: #ff5555;
        }

        #debug-console .log-warn {
            color: #ffb86c;
        }

        #debug-console .log-info {
            color: #8be9fd;
        }

        #debug-console .log-time {
            color: #6272a4;
            margin-right: 5px;
        }

        #debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 10001;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.5;
        }

        #debug-toggle:hover {
            opacity: 1;
        }

        /* ==================== NEW GAME MODES STYLES ==================== */

        /* 1. Objective Mode (ÿßŸÑŸáÿØŸÅ) */
        .objective-game {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .puzzle-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .constraints-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .constraint-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-right: 4px solid var(--text-gray);
            transition: all 0.3s ease;
        }

        .constraint-item.valid {
            background: rgba(46, 204, 113, 0.2);
            border-right-color: #2ecc71;
        }

        .constraint-item.invalid {
            background: rgba(231, 76, 60, 0.2);
            border-right-color: #e74c3c;
        }

        .constraint-icon {
            font-size: 1.2rem;
        }

        .objective-input-area input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        /* 2. Survival Mode (ÿßŸÑÿ®ŸÇÿßÿ°) */
        .survival-game {
            text-align: center;
        }

        .survival-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 12px;
            min-width: 100px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .survival-challenge {
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(239, 35, 60, 0.1), rgba(217, 4, 41, 0.1));
            border-radius: 20px;
            border: 1px solid rgba(239, 35, 60, 0.3);
        }

        .category-prompt {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .required-letter {
            font-size: 4rem;
            color: var(--accent-red);
            font-weight: 800;
            margin-bottom: 30px;
            display: block;
        }

        .survival-input-area input {
            width: 80%;
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 50px;
            border: 2px solid var(--accent-red);
            background: transparent;
            color: white;
            text-align: center;
        }

        /* 3. Memory Mode (ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©) */
        .memory-game .memory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .memory-card {
            background: rgba(255, 255, 255, 0.1);
            aspect-ratio: 1;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: flipIn 0.5s ease;
        }

        .memory-card.hidden {
            background: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.05) 10px, rgba(255, 255, 255, 0.1) 10px, rgba(255, 255, 255, 0.1) 20px);
            color: transparent;
        }

        .memory-input-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* 4. Multiphase & General */
        .phase-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--surface-light);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .timer-warning {
            color: var(--accent-red);
            animation: pulse 1s infinite;
        }

        @keyframes flipIn {
            from {
                transform: rotateY(90deg);
                opacity: 0;
            }

            to {
                transform: rotateY(0);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e2f, #2d2d44);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--text-white);
        }

        .modal-message {
            font-size: 1.1rem;
            color: var(--text-gray);
            margin-bottom: 30px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-actions .btn {
            min-width: 120px;
        }

        .btn-accept {
            background: linear-gradient(135deg, #06d6a0, #059669);
            box-shadow: 0 5px 15px rgba(6, 214, 160, 0.4);
            border: none;
        }

        .btn-decline {
            background: linear-gradient(135deg, #ef233c, #b91c1c);
            box-shadow: 0 5px 15px rgba(239, 35, 60, 0.4);
            border: none;
        }

        .btn-waiting {
            background: #4b5563;
            cursor: wait;
            opacity: 0.8;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <!-- Debug Console Elements -->
    <div id="debug-console"></div>
    <button id="debug-toggle" onclick="toggleDebugConsole()">üêû Log</button>
    <script>
        // Debug Console Logic
        (function () {
            const consoleEl = document.getElementById('debug-console');
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;

            function formatTime() {
                const now = new Date();
                return now.toLocaleTimeString() + '.' + now.getMilliseconds();
            }

            function logToOverlay(type, args) {
                if (!consoleEl) return;
                const msg = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try { return JSON.stringify(arg); } catch (e) { return String(arg); }
                    }
                    return String(arg);
                }).join(' ');

                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.innerHTML = `<span class="log-time">[${formatTime()}]</span> ${msg}`;
                consoleEl.appendChild(entry);
                consoleEl.scrollTop = consoleEl.scrollHeight;

                // Limit logs to prevent memory issues
                if (consoleEl.children.length > 200) {
                    consoleEl.removeChild(consoleEl.firstChild);
                }
            }

            console.log = function () { originalLog.apply(console, arguments); logToOverlay('info', arguments); };
            console.warn = function () { originalWarn.apply(console, arguments); logToOverlay('warn', arguments); };
            console.error = function () { originalError.apply(console, arguments); logToOverlay('error', arguments); };

            window.toggleDebugConsole = function () {
                if (consoleEl.style.display === 'none' || consoleEl.style.display === '') {
                    consoleEl.style.display = 'block';
                } else {
                    consoleEl.style.display = 'none';
                }
            };

            // Log global errors
            window.onerror = function (msg, url, line, col, error) {
                console.error(`Global Error: ${msg} at ${url}:${line}:${col}`, error);
            };

            // Log unhandled promise rejections
            window.onunhandledrejection = function (event) {
                console.error('Unhandled Promise Rejection:', event.reason);
            };

            console.log('Debug console initialized');
        })();
    </script>
    <!-- Friends Toggle Button -->
    <button class="friends-toggle" id="friends-toggle">
        üë•
        <span class="notification-badge" id="notification-badge" style="display:none;">0</span>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Friends Sidebar -->
    <div class="friends-sidebar" id="friends-sidebar">
        <div class="friends-header">
            <h3>üë• ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</h3>
            <button class="close-sidebar" id="close-sidebar">‚úï</button>
        </div>

        <div class="friends-tabs">
            <button class="friends-tab active" data-tab="friends">ÿ£ÿµÿØŸÇÿßÿ¶Ÿä</button>
            <button class="friends-tab" data-tab="requests">ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</button>
            <button class="friends-tab" data-tab="add">ÿ•ÿ∂ÿßŸÅÿ©</button>
        </div>

        <div class="friends-content">
            <!-- My ID Section (shown in Add tab) -->
            <div id="my-id-section" class="my-id-section" style="display:none;">
                <label>üÜî ŸÖÿπÿ±ŸëŸÅŸÉ ŸÑŸÑÿ£ÿµÿØŸÇÿßÿ°:</label>
                <div class="user-id" id="my-user-id"></div>
                <button id="copy-my-id">üìã ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸëŸÅ</button>
            </div>

            <!-- Add Friend Section -->
            <div id="add-friend-section" class="add-friend-section" style="display:none;">
                <input type="text" id="friend-id-input" placeholder="ŸÖÿπÿ±ŸëŸÅ ÿßŸÑÿµÿØŸäŸÇ...">
                <button id="send-friend-request">ÿ•ÿ∂ÿßŸÅÿ©</button>
            </div>

            <!-- Friends List -->
            <div id="friends-list"></div>

            <!-- Requests List -->
            <div id="requests-list" style="display:none;"></div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="invite-modal" id="invite-modal">
        <div class="invite-modal-content">
            <h3>üì© ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®!</h3>
            <p id="invite-message"></p>
            <div class="invite-buttons">
                <button class="btn btn-primary" id="accept-invite">‚úÖ ŸÇÿ®ŸàŸÑ</button>
                <button class="btn btn-secondary" id="reject-invite">‚ùå ÿ±ŸÅÿ∂</button>
            </div>
        </div>
    </div>

    <!-- Invite Waiting Modal -->
    <div class="invite-modal" id="invite-waiting-modal">
        <div class="invite-modal-content">
            <h3>üì§ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿπŸàÿ©</h3>
            <p>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ±ÿØ <span id="invited-friend-name"></span>...</p>
            <div class="invite-waiting">
                <div class="spinner"></div>
                <span id="invite-countdown">15</span> ÿ´ÿßŸÜŸäÿ© ŸÖÿ™ÿ®ŸÇŸäÿ©
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-invite">ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØÿπŸàÿ©</button>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel hidden" id="chat-panel">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-header-avatar" id="chat-avatar">?</div>
                <span id="chat-friend-name">üí¨ ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</span>
            </div>
            <button class="chat-close" id="chat-close">‚úï</button>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="chat-empty">
                <div>
                    <div class="icon">üí¨</div>
                    <p>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©!</p>
                </div>
            </div>
        </div>

        <div class="chat-typing" id="chat-typing" style="display:none;">
            ŸäŸÉÿ™ÿ®...
        </div>

        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." maxlength="500">
            <button class="chat-send-btn" id="chat-send">‚û§</button>
        </div>
    </div>

    <div class="container">
        <!-- Welcome Screen - New Design -->
        <div id="welcome-screen" class="screen active">
            <!-- Header -->
            <div class="welcome-header">
                <h1 class="logo">üé≤ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ</h1>
                <p class="subtitle">ÿßÿ≥ŸÖ ¬∑ ÿ≠ŸäŸàÿßŸÜ ¬∑ ŸÜÿ®ÿßÿ™ ¬∑ ÿ¨ŸÖÿßÿØ ¬∑ ÿ®ŸÑÿßÿØ</p>
            </div>

            <!-- Mode Selection Cards - ALL 6 MODES -->
            <div class="mode-selection">
                <h2 class="section-title">üéÆ ÿßÿÆÿ™ÿ± ŸÜŸÖÿ∑ ÿßŸÑŸÑÿπÿ®</h2>
                <div class="mode-cards" id="mode-cards">
                    <!-- Classic Mode Card -->
                    <div class="mode-card selected" data-mode="classic" onclick="selectMode('classic')">
                        <div class="mode-card-badge">ŸÉŸÑÿßÿ≥ŸäŸÉŸä</div>
                        <div class="mode-card-icon">üéØ</div>
                        <div class="mode-card-title">1 ÿ∂ÿØ 1</div>
                        <div class="mode-card-desc">60 ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ©</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Multi-Phase Mode Card -->
                    <div class="mode-card" data-mode="multiphase" onclick="selectMode('multiphase')">
                        <div class="mode-card-badge new">‚≠ê ÿ¨ÿØŸäÿØ</div>
                        <div class="mode-card-icon">‚ö°</div>
                        <div class="mode-card-title">ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ</div>
                        <div class="mode-card-desc">ÿ≥ÿ±ÿπÿ© + ÿØŸÇÿ© + ÿ™ÿ≠ÿØŸä</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Survival Mode Card -->
                    <div class="mode-card" data-mode="survival" onclick="selectMode('survival')">
                        <div class="mode-card-badge new">üíÄ ÿ¨ÿØŸäÿØ</div>
                        <div class="mode-card-icon">üíÄ</div>
                        <div class="mode-card-title">ÿßŸÑÿ®ŸÇÿßÿ°</div>
                        <div class="mode-card-desc">ÿÆÿ∑ÿ£ Ÿàÿßÿ≠ÿØ = ÿÆÿ±Ÿàÿ¨</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Memory Mode Card -->
                    <div class="mode-card" data-mode="memory" onclick="selectMode('memory')">
                        <div class="mode-card-badge new">üß† ÿ¨ÿØŸäÿØ</div>
                        <div class="mode-card-icon">üß†</div>
                        <div class="mode-card-title">ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©</div>
                        <div class="mode-card-desc">ÿßÿ≠ŸÅÿ∏ ÿ´ŸÖ ÿ£ÿ¨ÿ®</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Bluff Mode Card -->
                    <div class="mode-card" data-mode="bluff" onclick="selectMode('bluff')">
                        <div class="mode-card-badge new">üé≠ ÿ¨ÿØŸäÿØ</div>
                        <div class="mode-card-icon">üé≠</div>
                        <div class="mode-card-title">ÿßŸÑÿÆÿØÿßÿπ</div>
                        <div class="mode-card-desc">ŸÖŸÜ ÿßŸÑŸÉÿßÿ∞ÿ®ÿü</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Objective Mode Card -->
                    <div class="mode-card" data-mode="objective" onclick="selectMode('objective')">
                        <div class="mode-card-badge new">üéØ ÿ¨ÿØŸäÿØ</div>
                        <div class="mode-card-icon">üß©</div>
                        <div class="mode-card-title">ÿßŸÑŸáÿØŸÅ</div>
                        <div class="mode-card-desc">ÿ≠ŸÑ ÿßŸÑŸÑÿ∫ÿ≤</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>
                </div>
            </div>

            <!-- Player Name Input -->
            <div class="player-name-section">
                <div class="input-group compact">
                    <label>üë§ ÿßÿ≥ŸÖŸÉ</label>
                    <input type="text" id="player-name-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="welcome-actions">
                <button class="btn btn-primary btn-large" id="create-room-btn">
                    <span class="btn-icon">‚ûï</span>
                    <span>ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©</span>
                </button>
                <button class="btn btn-secondary btn-large" id="join-room-btn">
                    <span class="btn-icon">üö™</span>
                    <span>ÿßŸÜÿ∂ŸÖÿßŸÖ ÿ®ŸÉŸàÿØ</span>
                </button>
                <button class="btn btn-secondary btn-large" onclick="window.testAIConnection()">
                    <span class="btn-icon">üß™</span>
                    <span>ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ</span>
                </button>
                <button class="btn btn-secondary btn-large" onclick="window.testGameValidation()">
                    <span class="btn-icon">üß†</span>
                    <span>ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇ</span>
                </button>
            </div>

            <!-- Categories Preview -->
            <div class="categories-preview">
                <span class="category-badge" style="background:var(--accent-red)">ŸàŸÑÿØ</span>
                <span class="category-badge" style="background:var(--accent-pink)">ÿ®ŸÜÿ™</span>
                <span class="category-badge" style="background:var(--accent-green)">ÿÆÿ∂ÿßÿ±</span>
                <span class="category-badge" style="background:var(--accent-lime)">ŸÅŸàÿßŸÉŸá</span>
                <span class="category-badge" style="background:#6c757d">ÿ¨ŸÖÿßÿØ</span>
                <span class="category-badge" style="background:var(--accent-blue)">ÿ≠ŸäŸàÿßŸÜ</span>
                <span class="category-badge" style="background:var(--accent-purple)">ÿ®ŸÑÿßÿØ</span>
                <span class="category-badge" style="background:var(--accent-cyan)">ŸÖÿØŸäŸÜÿ©</span>
                <span class="category-badge" style="background:var(--accent-orange)">ŸÖŸáŸÜÿ©</span>
            </div>
        </div>

        <!-- Room Screen -->
        <div id="room-screen" class="screen">
            <button class="btn btn-secondary" id="back-to-welcome" style="align-self:flex-start;">‚Üí ÿßŸÑÿ±ÿ¨Ÿàÿπ</button>
            <div class="room-card" id="create-room-card" style="display:none;">
                <h2>üéÆ ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©</h2>
                <div class="input-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®</label>
                    <input type="text" id="create-player-name" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
                <div class="input-group">
                    <label>ÿπÿØÿØ ÿßŸÑÿ¨ŸàŸÑÿßÿ™</label>
                    <select id="rounds-select"
                        style="width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);">
                        <option value="3">3 ÿ¨ŸàŸÑÿßÿ™ (ÿ≥ÿ±Ÿäÿπ)</option>
                        <option value="5" selected>5 ÿ¨ŸàŸÑÿßÿ™ (ŸÖÿ™Ÿàÿ≥ÿ∑)</option>
                        <option value="10">10 ÿ¨ŸàŸÑÿßÿ™ (ÿ™ÿ≠ÿØŸä)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="confirm-create-room" style="width:100%;">ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
                <div id="created-room-info" style="display:none;margin-top:20px;">
                    <p style="text-align:center;color:var(--text-gray);">ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©:</p>
                    <div class="room-code" id="room-code-display"></div>
                    <button class="btn btn-secondary" id="copy-room-code" style="width:100%;margin-top:10px;">üìã ŸÜÿ≥ÿÆ
                        ÿßŸÑŸÉŸàÿØ</button>
                </div>
            </div>
            <div class="room-card" id="join-room-card" style="display:none;">
                <h2>üö™ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ∫ÿ±ŸÅÿ©</h2>
                <div class="input-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®</label>
                    <input type="text" id="join-player-name" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
                <div class="input-group">
                    <label>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©</label>
                    <input type="text" id="room-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ..." maxlength="6"
                        style="text-transform:uppercase;letter-spacing:3px;text-align:center;">
                </div>
                <button class="btn btn-primary" id="confirm-join-room" style="width:100%;">ÿßŸÜÿ∂ŸÖÿßŸÖ</button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="screen">
            <h2>‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ¢ÿÆÿ±...</h2>
            <div class="waiting-animation">
                <div class="waiting-dot"></div>
                <div class="waiting-dot"></div>
                <div class="waiting-dot"></div>
            </div>
            <p>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©: <span id="waiting-room-code" style="color:var(--accent-blue);font-weight:700;"></span></p>
            <p id="players-count">ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ: 1/2</p>

            <!-- üî¥ Manual Start Button (Host Only) -->
            <button class="btn btn-primary" id="force-start-btn" style="display:none; margin-bottom: 10px;"
                onclick="window.GameController.startGame()">üöÄ ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ© ŸÅŸàÿ±ÿßŸã</button>

            <button class="btn btn-secondary" id="leave-room-btn">ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
        </div>

        <!-- Game Screen - Dynamic Mode-Specific UI -->
        <div id="game-screen" class="screen">
            <!-- üî¥ MODE-SPECIFIC UI IS BUILT DYNAMICALLY HERE -->
            <div id="game-container">
                <!-- UI will be injected by mode-specific UI builder -->
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <div class="results-container" id="results-container"></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- üéÆ Game Engine Modules -->
    <script src="game-engine.js"></script>
    <script src="game-controller.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAwdE4U_ycmvpPhUt1qh4IUGxB1bJgh5as",
            authDomain: "word-game-7451f.firebaseapp.com",
            databaseURL: "https://word-game-7451f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "word-game-7451f",
            storageBucket: "word-game-7451f.firebasestorage.app",
            messagingSenderId: "824692932627",
            appId: "1:824692932627:web:9250e379d5455a85ce3fe6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // üî¥ Expose database globally for game-controller.js
        window.database = database;

        // ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
        // ÿßÿ≥ÿ™ÿÆÿØŸÖ Cloudflare Worker ŸÑŸÑŸÜÿ¥ÿ± ÿπŸÑŸâ GitHub Pages
        window.WORKER_URL = "https://shiny-term-8522.ahanfouf9.workers.dev";

        // ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑ (ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ÿπŸÜÿØ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Worker)
        window.GEMINI_API_KEY = "";

        // Game Variables
        let currentRoomId = null, currentPlayerId = null, playerName = '', isHost = false;
        let gameTimerInterval = null, currentTimeLeft = 60;
        let currentRoundId = 0; // ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑŸÑÿ™ÿ≤ÿßŸÖŸÜ
        let currentPhase = null; // ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© (speed/accuracy/null ŸÑŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä)
        let currentPhaseIndex = 0; // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        let currentMode = null; // üî¥ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑÿπÿ®ÿ©
        let roomListener = null; // ÿ≠ŸÅÿ∏ ŸÖÿ±ÿ¨ÿπ ÿßŸÑŸÄ listener ŸÑÿ•ÿ≤ÿßŸÑÿ™Ÿá ŸÑÿßÿ≠ŸÇÿßŸã
        let lastInviteTime = 0; // Rate limit ÿπŸÑŸâ ÿßŸÑÿØÿπŸàÿßÿ™
        const INVITE_COOLDOWN = 5000; // 5 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑÿØÿπŸàÿßÿ™
        let currentPhaseStartAt = 0; // ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÑŸÑŸÄ anti-cheat Ÿà timer

        // üî¥ CRITICAL: Use modes from GameEngine (6 modes)
        const MODES = window.GameEngine ? window.GameEngine.MODES : {
            classic: { name: 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä', phases: ['accuracy'], durations: { accuracy: 60 } },
            multiphase: { name: 'ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ', phases: ['speed', 'accuracy', 'challenge'], durations: { speed: 20, accuracy: 30, challenge: 10 } },
            survival: { name: 'ÿßŸÑÿ®ŸÇÿßÿ°', phases: ['survival'], durations: { survival: 7 } },
            memory: { name: 'ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©', phases: ['show', 'recall'], durations: { show: 5, recall: 15 } },
            bluff: { name: 'ÿßŸÑÿÆÿØÿßÿπ', phases: ['answer', 'vote', 'reveal'], durations: { answer: 30, vote: 15, reveal: 5 } },
            objective: { name: 'ÿßŸÑŸáÿØŸÅ', phases: ['solve'], durations: { solve: 45 } }
        };

        // Use categories from GameEngine if available
        const categories = window.GameEngine ? window.GameEngine.CATEGORIES : [
            { id: 'boyName', label: 'ÿßÿ≥ŸÖ ŸàŸÑÿØ', class: 'cat-boy-name', prompt: 'ÿßÿ≥ŸÖ ŸàŸÑÿØ (ÿ∞ŸÉÿ±)' },
            { id: 'girlName', label: 'ÿßÿ≥ŸÖ ÿ®ŸÜÿ™', class: 'cat-girl-name', prompt: 'ÿßÿ≥ŸÖ ÿ®ŸÜÿ™ (ÿ£ŸÜÿ´Ÿâ)' },
            { id: 'vegetable', label: 'ÿÆÿ∂ÿßÿ±', class: 'cat-vegetable', prompt: 'ŸÜŸàÿπ ÿÆÿ∂ÿßÿ±' },
            { id: 'fruit', label: 'ŸÅŸàÿßŸÉŸá', class: 'cat-fruit', prompt: 'ŸÜŸàÿπ ŸÅÿßŸÉŸáÿ©' },
            { id: 'object', label: 'ÿ¨ŸÖÿßÿØ', class: 'cat-object', prompt: 'ÿ¨ŸÖÿßÿØ (ÿ¥Ÿäÿ° ÿ∫Ÿäÿ± ÿ≠Ÿä)' },
            { id: 'animal', label: 'ÿ≠ŸäŸàÿßŸÜ', class: 'cat-animal', prompt: 'ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ' },
            { id: 'country', label: 'ÿ®ŸÑÿßÿØ', class: 'cat-country', prompt: 'ÿßÿ≥ŸÖ ÿØŸàŸÑÿ©/ÿ®ŸÑÿØ' },
            { id: 'city', label: 'ŸÖÿØŸäŸÜÿ©', class: 'cat-city', prompt: 'ÿßÿ≥ŸÖ ŸÖÿØŸäŸÜÿ©' },
            { id: 'job', label: 'ŸÖŸáŸÜÿ©', class: 'cat-job', prompt: 'ÿßÿ≥ŸÖ ŸÖŸáŸÜÿ©/Ÿàÿ∏ŸäŸÅÿ©' }
        ];

        // ÿßŸÑÿ≠ÿ±ŸàŸÅ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        const arabicLetters = ['ÿß', 'ÿ®', 'ÿ™', 'ÿ´', 'ÿ¨', 'ÿ≠', 'ÿÆ', 'ÿØ', 'ÿ∞', 'ÿ±', 'ÿ≤', 'ÿ≥', 'ÿ¥', 'ÿµ', 'ÿ∂', 'ÿ∑', 'ÿ∏', 'ÿπ', 'ÿ∫', 'ŸÅ', 'ŸÇ', 'ŸÉ', 'ŸÑ', 'ŸÖ', 'ŸÜ', 'Ÿá', 'Ÿà', 'Ÿä'];

        // üî¥ NO initCategoriesUI here - UI is built dynamically by mode-specific builders

        // Helper Functions
        const screens = { welcome: document.getElementById('welcome-screen'), room: document.getElementById('room-screen'), waiting: document.getElementById('waiting-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen') };

        function showScreen(name) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[name].classList.add('active'); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }
        function generateRoomCode() { const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let r = ''; for (let i = 0; i < 6; i++) r += c[Math.floor(Math.random() * c.length)]; return r; }
        function generatePlayerId() { return 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6); }
        function getRandomLetter() {
            if (window.GameEngine && window.GameEngine.getRandomLetter) {
                return window.GameEngine.getRandomLetter();
            }
            return arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
        }

        // Mode selection - supports all 6 modes
        let selectedMode = 'classic';

        function selectMode(mode) {
            console.log('üéÆ User selected mode:', mode);

            // üî¥ Validate mode exists
            if (!MODES[mode]) {
                console.error('Invalid mode:', mode);
                return;
            }

            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.mode === mode);
            });

            // Show mode info toast
            const modeConfig = MODES[mode];
            showToast(`${modeConfig.icon || 'üéÆ'} ${modeConfig.name}`);
        }

        // Phase helpers
        function getPhaseLabel(phase) {
            const labels = {
                'speed': 'ÿßŸÑÿ≥ÿ±ÿπÿ© ‚ö°',
                'accuracy': 'ÿßŸÑÿØŸÇÿ© üéØ',
                'challenge': 'ÿßŸÑÿ™ÿ≠ÿØŸä üî•'
            };
            return labels[phase] || 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä';
        }

        function generateProgressDots(currentIndex, total) {
            let dots = '';
            for (let i = 0; i < total; i++) {
                dots += i <= currentIndex ? '‚óè' : '‚óã';
                if (i < total - 1) dots += ' ';
            }
            return dots;
        }

        function normalizeArabic(letter) {
            const n = { 'ÿ£': 'ÿß', 'ÿ•': 'ÿß', 'ÿ¢': 'ÿß', 'ÿ©': 'Ÿá', 'Ÿâ': 'Ÿä' };
            return n[letter] || letter;
        }

        function getFirstLetter(word) {
            if (!word || !word.trim()) return '';
            let w = word.trim();
            if (w.startsWith('ÿßŸÑ') && w.length > 2) w = w.substring(2);
            return normalizeArabic(w.charAt(0));
        }

        // AI Verification with Gemini - STRICT ARABIC
        async function verifyWithAI(answers, letter) {
            const results = {};
            let totalScore = 0;
            const targetLetter = normalizeArabic(letter);

            // ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑÿ∑ŸàŸÑ ÿßŸÑŸÉŸÑŸÖÿ© (ÿ≠ÿ±ŸÅŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)
            const MIN_WORD_LENGTH = 2;

            // ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä - Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ®ÿØÿ£ ÿßŸÑŸÉŸÑŸÖÿ© ÿ®ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑÿµÿ≠Ÿäÿ≠ Ÿàÿ™ŸÉŸàŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä
            function basicValidation(answer, letter) {
                if (!answer) return false;
                const trimmed = answer.trim();
                if (trimmed.length < MIN_WORD_LENGTH) return false;

                // üî¥ FORCE ARABIC CHARACTERS ONLY
                if (!/^[\u0600-\u06FF\s]+$/.test(trimmed)) return false;

                const firstLetter = getFirstLetter(trimmed);
                return firstLetter === normalizeArabic(letter);
            }

            // ÿ™ÿ≠ÿØŸäÿØ ŸÖÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸäŸàÿ¨ÿØ Ÿàÿ≥ŸäŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
            const hasWorker = WORKER_URL && WORKER_URL.trim() !== "";
            const hasApiKey = GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "";

            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ Worker ÿ£Ÿà API Keyÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
            if (!hasWorker && !hasApiKey) {
                categories.forEach(cat => {
                    const answer = answers[cat.id] || '';
                    const isValid = basicValidation(answer, targetLetter);
                    results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                    totalScore += isValid ? 10 : 0;
                });
                return { score: totalScore, results };
            }

            // Build strict prompt for Gemini
            const prompt = `ÿ£ŸÜÿ™ ÿ≠ŸÉŸÖ ÿµÿßÿ±ŸÖ ÿ¨ÿØÿßŸã ŸÅŸä ŸÑÿπÿ®ÿ© "ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ".
ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸáŸà: "${targetLetter}"

‚ö†Ô∏è ŸÇŸàÿßÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿµÿßÿ±ŸÖÿ©:
1. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ®ÿØÿ£ ÿßŸÑŸÉŸÑŸÖÿ© ÿ®ÿßŸÑÿ≠ÿ±ŸÅ "${targetLetter}" ÿ®ÿßŸÑÿ∂ÿ®ÿ∑ (ÿ™ÿ¨ÿßŸáŸÑ "ÿßŸÑ" ÿßŸÑÿ™ÿπÿ±ŸäŸÅ).
2. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑŸÉŸÑŸÖÿ© ÿπÿ±ÿ®Ÿäÿ© ÿµÿ≠Ÿäÿ≠ÿ© Ÿàÿ≠ŸÇŸäŸÇŸäÿ© ŸàŸÖÿ¥ŸáŸàÿ±ÿ©.
3. ÿßÿ≥ŸÖ ŸàŸÑÿØ/ÿ®ŸÜÿ™: ÿ£ÿ≥ŸÖÿßÿ° ÿπÿ±ÿ®Ÿäÿ© ÿ≠ŸÇŸäŸÇŸäÿ©.
4. ÿÆÿ∂ÿßÿ±/ŸÅŸàÿßŸÉŸá: ÿ™ÿµŸÜŸäŸÅ ÿØŸÇŸäŸÇ (ŸÖÿ´ŸÑÿßŸã: ÿßŸÑÿ®ÿ∑ÿßÿ∑ÿ≥ ŸÑŸäÿ≥ÿ™ ŸÅÿßŸÉŸáÿ©).
5. ÿ¨ŸÖÿßÿØ: ÿ¥Ÿäÿ° ÿµŸÑÿ® ÿ∫Ÿäÿ± ÿ≠Ÿä.
6. ÿ≠ŸäŸàÿßŸÜ/ÿ®ŸÑÿßÿØ/ŸÖÿØŸäŸÜÿ©/ŸÖŸáŸÜÿ©: ÿ£ÿ≥ŸÖÿßÿ° ÿ≠ŸÇŸäŸÇŸäÿ© ŸÖŸàÿ¨ŸàÿØÿ©.

ÿ£ÿπÿØ JSON ŸÅŸÇÿ∑ ÿ®ÿØŸàŸÜ ŸÜÿµŸàÿµ ÿ£ÿÆÿ±Ÿâ:
{"catId": {"valid": true/false}, ...}

ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™:
${JSON.stringify(answers)}`;

            try {
                let text = '';
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // üî¥ 5 Second Timeout

                if (hasWorker) {
                    try {
                        const response = await fetch(WORKER_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: prompt }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const data = await response.json();
                        if (data.candidates) {
                            text = data.candidates[0]?.content?.parts?.[0]?.text || '';
                        } else if (data.text) {
                            text = data.text;
                        } else if (typeof data === 'string') {
                            text = data;
                        } else {
                            text = JSON.stringify(data);
                        }
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                } else {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: { temperature: 0.1 }
                            }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const data = await response.json();
                        text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                }

                // Robust JSON Extraction
                const jsonMatch = text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const aiResults = JSON.parse(jsonMatch[0]);

                    categories.forEach(cat => {
                        const answer = answers[cat.id] || '';
                        const localCheck = basicValidation(answer, targetLetter);

                        // AI Decision Logic
                        // AI must say true AND basic validation must pass
                        const aiDecision = aiResults[cat.id] ? aiResults[cat.id].valid === true : false;

                        // Final Verdict
                        const isValid = localCheck && aiDecision;

                        results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                        totalScore += isValid ? 10 : 0;
                    });
                    return { score: totalScore, results };
                }
            } catch (error) {
                console.error('AI verification error:', error);
            }

            // Fallback
            categories.forEach(cat => {
                const answer = answers[cat.id] || '';
                const isValid = basicValidation(answer, targetLetter);
                results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                totalScore += isValid ? 10 : 0;
            });
            return { score: totalScore, results };
        }

        // Generate AI Content for Modes
        async function generateAIContent(mode, roundNumber, currentLetter) {
            const hasWorker = WORKER_URL && WORKER_URL.trim() !== "";
            const hasApiKey = GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "";

            if (!hasWorker && !hasApiKey) return null;

            let prompt = "";

            if (mode === 'survival') {
                prompt = `ÿßŸÇÿ™ÿ±ÿ≠ ŸÅÿ¶ÿ© ÿµÿπÿ®ÿ© ŸàŸÖŸÖÿ™ÿπÿ© ŸÑŸÑÿπÿ®ÿ© "ÿ™ÿ≠ÿØŸä ÿßŸÑŸÉŸÑŸÖÿßÿ™" (ŸÖÿ´ŸÑ: "ÿ≠ŸäŸàÿßŸÜ ÿ®ÿ≠ÿ±Ÿä"ÿå "ÿ¥Ÿäÿ° ŸÜÿ≥ÿ™ÿÆÿØŸÖŸá ŸäŸàŸÖŸäÿßŸã"ÿå "ÿ£ŸÉŸÑÿ© ÿ¥ÿßŸÖŸäÿ©").
ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸáŸà: ${currentLetter}
ÿßŸÑÿ¨ŸàŸÑÿ©: ${roundNumber}
ÿ±ÿØ ÿ®ŸÄ JSON ŸÅŸÇÿ∑: {"category": "ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ¶ÿ©", "example": "ŸÖÿ´ÿßŸÑ ÿµÿ≠Ÿäÿ≠"}`;
            } else if (mode === 'memory') {
                prompt = `ÿßŸÇÿ™ÿ±ÿ≠ ŸÇÿßÿ¶ŸÖÿ© ŸÖŸÜ 5 ŸÉŸÑŸÖÿßÿ™ ÿπÿ±ÿ®Ÿäÿ© ŸÖÿ£ŸÑŸàŸÅÿ© Ÿàÿ∫Ÿäÿ± ŸÖÿ™ÿ±ÿßÿ®ÿ∑ÿ© ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©. 
ÿßŸÑÿ¨ŸàŸÑÿ©: ${roundNumber}
ÿ±ÿØ ÿ®ŸÄ JSON ŸÅŸÇÿ∑: {"words": ["ŸÉŸÑŸÖÿ©1", "ŸÉŸÑŸÖÿ©2", "ŸÉŸÑŸÖÿ©3", "ŸÉŸÑŸÖÿ©4", "ŸÉŸÑŸÖÿ©5"]}`;
            } else if (mode === 'objective') {
                prompt = `ÿßŸÇÿ™ÿ±ÿ≠ ŸÑÿ∫ÿ≤ÿßŸã ŸÑÿ∫ŸàŸäÿßŸã ŸÖŸÖÿ™ÿπÿßŸã Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ 3 ÿ¥ÿ±Ÿàÿ∑.
ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿßÿ≠: ${currentLetter}
ÿ±ÿØ ÿ®ŸÄ JSON ŸÅŸÇÿ∑: 
{
  "constraints": [
    {"type": "startsWith", "value": "${currentLetter}", "label": "Ÿäÿ®ÿØÿ£ ÿ®ÿ≠ÿ±ŸÅ ${currentLetter}"},
    {"type": "contains", "value": "ÿ≠ÿ±ŸÅ_ÿπÿ¥Ÿàÿßÿ¶Ÿä", "label": "Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ≠ÿ±ŸÅ ..."},
    {"type": "length", "value": 5, "label": "Ÿäÿ™ŸÉŸàŸÜ ŸÖŸÜ 5 ÿ£ÿ≠ÿ±ŸÅ"}
  ]
}`;
            } else {
                return null;
            }

            try {
                let text = '';
                if (hasWorker) {
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });
                    const data = await response.json();
                    if (data.candidates) {
                        text = data.candidates[0]?.content?.parts?.[0]?.text || '';
                    } else if (data.text) {
                        text = data.text;
                    } else {
                        text = JSON.stringify(data);
                    }
                } else {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    const data = await response.json();
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                }

                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.error("AI Generation Error:", e);
                return null;
            }
            return null;
        }

        // Window Exports
        window.verifyWithAI = verifyWithAI;
        window.generateAIContent = generateAIContent;

        // üî¥ Legacy functions removed.
        // Use window.GameController.createRoom / joinRoom / startGame instead.


        // üî¥ Get answers using mode-specific UI_BUILDER
        // üî¥ Legacy game functions removed. 
        // All logic delegated to GameController.js and GameEngine.js


        // ==================== EVENT HANDLERS ====================

        document.getElementById('create-room-btn').onclick = async () => {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error'); return; }

            const activeCard = document.querySelector('.mode-card.selected');
            const mode = activeCard ? activeCard.dataset.mode : selectedMode;

            try {
                // Initialize user if needed
                if (typeof initializeUser === 'function') initializeUser(name);

                const rounds = parseInt(document.getElementById('rounds-select').value) || 5;

                await window.GameController.createRoom(name, mode, rounds);
                syncGameState();

                document.getElementById('waiting-room-code').textContent = window.GameController.state.roomId;
                showScreen('waiting');
                showToast(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©! üéÆ ÿßŸÑŸÖŸàÿØ: ${MODES[mode]?.name || 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä'}`);

                // Start listening
                window.GameController.listenToRoom();
            } catch (e) { showToast('ÿÆÿ∑ÿ£: ' + e.message, 'error'); }
        };

        document.getElementById('join-room-btn').onclick = () => {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error'); return; }
            const code = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©:');
            if (code && code.trim()) {
                joinRoomHandler(name, code.trim().toUpperCase());
            }
        };

        async function joinRoomHandler(name, code) {
            try {
                if (typeof initializeUser === 'function') initializeUser(name);

                await window.GameController.joinRoom(code, name);
                syncGameState();

                document.getElementById('waiting-room-code').textContent = code;
                showScreen('waiting');

                window.GameController.listenToRoom();
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ! üö™');
            } catch (e) { showToast(e.message, 'error'); }
        }

        document.getElementById('back-to-welcome').onclick = async () => {
            await window.GameController.leaveRoom();
            syncGameState();
            showScreen('welcome');
        };

        document.getElementById('confirm-create-room').onclick = document.getElementById('create-room-btn').onclick; // Reuse handler

        document.getElementById('copy-room-code').onclick = () => {
            const code = document.getElementById('room-code-display').textContent || document.getElementById('waiting-room-code').textContent;
            navigator.clipboard.writeText(code);
            showToast('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!');
        };

        document.getElementById('confirm-join-room').onclick = async () => {
            const name = document.getElementById('join-player-name').value.trim();
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ', 'error'); return; }
            if (!code) { showToast('ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©', 'error'); return; }
            await joinRoomHandler(name, code);
        };

        document.getElementById('leave-room-btn').onclick = async () => {
            await window.GameController.leaveRoom();
            syncGameState();
            showScreen('welcome');
        };

        // Stop button is now handled by GameEngine setupModeHandler, but we ensure it's present
        // The UI Builder creates the stop button, and GameEngine binds events. 
        // No manual binding needed here unless for global fallback.

        // Buttons are now dynamically created in showResultsScreen
        const _playBtn = document.getElementById('play-again-btn');
        if (_playBtn) _playBtn.onclick = async () => {
            if (window.GameController.playAgain) {
                await window.GameController.playAgain();
            } else {
                location.reload();
            }
        };

        const _exitBtn = document.getElementById('exit-game-btn');
        if (_exitBtn) _exitBtn.onclick = async () => {
            await window.GameController.leaveRoom();
            syncGameState();
            showScreen('welcome');
        };

        function syncGameState() {
            if (window.GameController && window.GameController.state) {
                currentRoomId = window.GameController.state.roomId;
                currentPlayerId = window.GameController.state.playerId;
                playerName = window.GameController.state.playerName;
                isHost = window.GameController.state.isHost;
                currentMode = window.GameController.state.mode || selectedMode;
            }
        }
        // üî¥ FIX: Expose globally so game-controller.js can call it
        window.syncGameState = syncGameState;

        // ==================== FRIENDS SYSTEM ====================

        // User ID Management - ÿØÿßÿ¶ŸÖÿßŸã ŸÖŸàÿ¨ŸàÿØ
        let myUserId = localStorage.getItem('wordGameUserId');
        if (!myUserId) {
            myUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
            localStorage.setItem('wordGameUserId', myUserId);
        }

        let myUserName = localStorage.getItem('wordGameUserName') || '';
        let currentInvite = null;
        let inviteTimeout = null;
        let inviteCountdownInterval = null;
        let userInitialized = false;

        // Initialize user in Firebase - ŸäŸèŸÜÿ¥ÿ¶/ŸäŸèÿ≠ÿØŸëÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        function initializeUser(name) {
            if (!name) return;
            myUserName = name;
            localStorage.setItem('wordGameUserName', name);

            // üî¥ ŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿπ GameController
            if (window.GameController) {
                window.GameController.state.playerName = name;
                window.GameController.state.playerId = myUserId; // ÿ™Ÿàÿ≠ŸäÿØ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™
            }

            console.log('Initializing user:', myUserId, name);

            database.ref('users/' + myUserId).update({
                name: name,
                online: true,
                lastSeen: Date.now()
            }).then(() => {
                console.log('User initialized in Firebase');
                userInitialized = true;
            }).catch(err => {
                console.error('Error initializing user:', err);
            });

            // Set offline on disconnect
            database.ref('users/' + myUserId + '/online').onDisconnect().set(false);
            database.ref('users/' + myUserId + '/lastSeen').onDisconnect().set(Date.now());
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏ÿßŸã
        if (myUserName) {
            initializeUser(myUserName);
        }

        // ÿ∑ŸÑÿ® ÿßŸÑÿßÿ≥ŸÖ ŸÇÿ®ŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°
        function ensureUserName() {
            if (myUserName) return true;

            const name = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ŸÑŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±:');
            if (name && name.trim()) {
                initializeUser(name.trim());
                return true;
            }
            showToast('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error');
            return false;
        }

        // Listen for invites
        function listenForInvites() {
            database.ref('roomInvites/' + myUserId).on('child_added', snap => {
                const invite = snap.val();
                if (!invite || Date.now() - invite.timestamp > 20000) {
                    snap.ref.remove();
                    return;
                }
                currentInvite = { ...invite, key: snap.key };
                showInviteModal(invite);
            });
        }

        // Listen for friend requests
        function listenForFriendRequests() {
            database.ref('friendRequests/' + myUserId).on('value', snap => {
                const requests = snap.val() || {};
                const count = Object.keys(requests).length;
                updateNotificationBadge(count);
                renderRequests(requests);
            });
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show invite modal
        function showInviteModal(invite) {
            document.getElementById('invite-message').textContent =
                `${invite.fromName} ŸäÿØÿπŸàŸÉ ŸÑŸÑÿπÿ® ŸÖÿπŸá!`;
            document.getElementById('invite-modal').classList.add('show');
        }

        // Hide invite modal
        function hideInviteModal() {
            document.getElementById('invite-modal').classList.remove('show');
            if (currentInvite) {
                database.ref(`roomInvites/${myUserId}/${currentInvite.key}`).remove();
                currentInvite = null;
            }
        }

        // Accept invite
        document.getElementById('accept-invite').onclick = async () => {
            if (!currentInvite || !currentInvite.roomId) {
                showToast('ÿßŸÑÿØÿπŸàÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©', 'error');
                hideInviteModal();
                return;
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            const inviteRoomId = currentInvite.roomId;
            const inviteKey = currentInvite.key;

            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑÿØÿπŸàÿ©
            document.getElementById('invite-modal').classList.remove('show');
            database.ref(`roomInvites/${myUserId}/${inviteKey}`).remove();
            currentInvite = null;

            // Set player name if needed
            if (!myUserName) {
                myUserName = 'ŸÑÿßÿπÿ®';
            }

            try {
                // Delegate to GameController
                await window.GameController.joinRoom(inviteRoomId, myUserName);

                // Sync local state
                currentRoomId = window.GameController.state.roomId;
                currentPlayerId = window.GameController.state.playerId;
                playerName = window.GameController.state.playerName;
                isHost = window.GameController.state.isHost;

                document.getElementById('waiting-room-code').textContent = inviteRoomId;
                showScreen('waiting');

                // Use NEW listener
                window.GameController.listenToRoom();
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ!');
            } catch (e) {
                showToast(e.message, 'error');
            }
        };

        // Reject invite
        document.getElementById('reject-invite').onclick = () => {
            hideInviteModal();
        };

        // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™
        async function createRoomAndInvite(friendId, friendName) {
            // üî¥ FIX: Always sync state from GameController before checking
            syncGameState();

            // ŸÖŸÜÿπ ÿßŸÑÿØÿπŸàÿßÿ™ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®
            if (currentRoomId) {
                showToast('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®', 'error');
                return;
            }

            // Rate limit - ŸÖŸÜÿπ ÿßŸÑŸÄ spam
            if (Date.now() - lastInviteTime < INVITE_COOLDOWN) {
                const waitTime = Math.ceil((INVITE_COOLDOWN - (Date.now() - lastInviteTime)) / 1000);
                showToast('ÿßŸÜÿ™ÿ∏ÿ± ' + waitTime + ' ÿ´ŸàÿßŸÜŸä', 'error');
                return;
            }
            lastInviteTime = Date.now();

            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿßÿ≥ŸÖÿå ÿßÿ∑ŸÑÿ®Ÿá
            if (!myUserName) {
                const name = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ:');
                if (!name || !name.trim()) {
                    showToast('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error');
                    return;
                }
                initializeUser(name.trim());
            }

            try {
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ sidebar
                closeFriendsSidebar();

                // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ© ÿπÿ®ÿ± GameController
                showToast('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©...');
                const code = await window.GameController.createRoom(
                    myUserName,
                    typeof selectedMode !== 'undefined' ? selectedMode : 'classic'
                );

                // Sync local variables
                currentRoomId = window.GameController.state.roomId;
                currentPlayerId = window.GameController.state.playerId;
                playerName = window.GameController.state.playerName;
                isHost = window.GameController.state.isHost;
                currentMode = typeof selectedMode !== 'undefined' ? selectedMode : 'classic';

                // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿπŸàÿ©
                await database.ref(`roomInvites/${friendId}/${Date.now()}`).set({
                    roomId: currentRoomId,
                    from: myUserId,
                    fromName: myUserName,
                    timestamp: Date.now()
                });

                // ÿπÿ±ÿ∂ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                document.getElementById('waiting-room-code').textContent = currentRoomId;
                showScreen('waiting');

                // Use NEW listener
                window.GameController.listenToRoom();

                // Show waiting modal
                document.getElementById('invited-friend-name').textContent = friendName;
                document.getElementById('invite-waiting-modal').classList.add('show');

                let countdown = 30;
                document.getElementById('invite-countdown').textContent = countdown;

                inviteCountdownInterval = setInterval(() => {
                    countdown--;
                    document.getElementById('invite-countdown').textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(inviteCountdownInterval);
                    }
                }, 1000);

                // Listen for room to become full
                const roomRef = database.ref('rooms/' + currentRoomId);
                const roomListener = roomRef.on('value', snap => {
                    const room = snap.val();
                    if (room && Object.keys(room.players || {}).length >= 2) {
                        clearTimeout(inviteTimeout);
                        clearInterval(inviteCountdownInterval);
                        document.getElementById('invite-waiting-modal').classList.remove('show');
                        roomRef.off('value', roomListener);
                        showToast('ÿßŸÜÿ∂ŸÖ ÿµÿØŸäŸÇŸÉ! üéâ');
                    }
                });

                // Timeout
                inviteTimeout = setTimeout(() => {
                    clearInterval(inviteCountdownInterval);
                    document.getElementById('invite-waiting-modal').classList.remove('show');
                    roomRef.off('value', roomListener);
                    showToast('ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸäÿØŸàŸäÿßŸã: ' + currentRoomId, 'error');
                }, 30000);

            } catch (error) {
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + error.message, 'error');
            }
        }

        // Send invite to friend (if already in a room)
        async function sendInviteToFriend(friendId, friendName) {
            // üî¥ FIX: Always sync state from GameController before checking
            syncGameState();

            if (!currentRoomId) {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ©
                await createRoomAndInvite(friendId, friendName);
                return;
            }

            // Send invite
            await database.ref(`roomInvites/${friendId}/${Date.now()}`).set({
                roomId: currentRoomId,
                from: myUserId,
                fromName: myUserName,
                timestamp: Date.now()
            });

            // Show waiting modal
            document.getElementById('invited-friend-name').textContent = friendName;
            document.getElementById('invite-waiting-modal').classList.add('show');

            let countdown = 15;
            document.getElementById('invite-countdown').textContent = countdown;

            inviteCountdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('invite-countdown').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(inviteCountdownInterval);
                }
            }, 1000);

            // Listen for room to become full
            const roomRef = database.ref('rooms/' + currentRoomId);
            const roomListener = roomRef.on('value', snap => {
                const room = snap.val();
                if (room && Object.keys(room.players || {}).length >= 2) {
                    // Friend joined!
                    clearTimeout(inviteTimeout);
                    clearInterval(inviteCountdownInterval);
                    document.getElementById('invite-waiting-modal').classList.remove('show');
                    roomRef.off('value', roomListener);
                    closeFriendsSidebar();
                }
            });

            // Timeout - fallback to room code
            inviteTimeout = setTimeout(() => {
                clearInterval(inviteCountdownInterval);
                document.getElementById('invite-waiting-modal').classList.remove('show');
                roomRef.off('value', roomListener);
                showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ±ÿØÿå ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸäÿØŸàŸäŸãÿß', 'error');
            }, 15000);
        }

        // Cancel invite
        document.getElementById('cancel-invite').onclick = () => {
            clearTimeout(inviteTimeout);
            clearInterval(inviteCountdownInterval);
            document.getElementById('invite-waiting-modal').classList.remove('show');
        };

        // Send friend request
        async function sendFriendRequest(friendId) {
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑÿßŸã
            if (!ensureUserName()) return;

            if (!friendId || friendId === myUserId) {
                showToast('ŸÖÿπÿ±ŸëŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠', 'error');
                return;
            }

            // Check if user exists
            const userSnap = await database.ref('users/' + friendId).once('value');
            if (!userSnap.exists()) {
                showToast('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ', 'error');
                return;
            }

            // Check if already friends
            const friendSnap = await database.ref(`users/${myUserId}/friends/${friendId}`).once('value');
            if (friendSnap.exists()) {
                showToast('Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿµÿØŸäŸÇŸÉ ÿ®ÿßŸÑŸÅÿπŸÑ', 'error');
                return;
            }

            // Send request
            await database.ref(`friendRequests/${friendId}/${myUserId}`).set({
                name: myUserName || 'ŸÑÿßÿπÿ®',
                timestamp: Date.now()
            });

            showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©!');
            document.getElementById('friend-id-input').value = '';
        }

        // Accept friend request
        async function acceptFriendRequest(fromUserId, fromName) {
            // Add to both users' friends list
            await database.ref(`users/${myUserId}/friends/${fromUserId}`).set({
                name: fromName,
                addedAt: Date.now()
            });
            await database.ref(`users/${fromUserId}/friends/${myUserId}`).set({
                name: myUserName || 'ŸÑÿßÿπÿ®',
                addedAt: Date.now()
            });

            // Remove request
            await database.ref(`friendRequests/${myUserId}/${fromUserId}`).remove();

            showToast(`${fromName} ÿ£ÿµÿ®ÿ≠ ÿµÿØŸäŸÇŸÉ!`);
            renderFriendsList();
        }

        // Reject friend request
        async function rejectFriendRequest(fromUserId) {
            await database.ref(`friendRequests/${myUserId}/${fromUserId}`).remove();
        }

        // Render friends list
        async function renderFriendsList() {
            const container = document.getElementById('friends-list');
            const friendsSnap = await database.ref(`users/${myUserId}/friends`).once('value');
            const friends = friendsSnap.val() || {};
            const friendIds = Object.keys(friends);

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ<br>ÿ£ÿ∂ŸÅ ÿ£ÿµÿØŸÇÿßÿ° ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿ∂ÿßŸÅÿ©"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const fid of friendIds) {
                const userSnap = await database.ref('users/' + fid).once('value');
                const user = userSnap.val() || { name: friends[fid].name, online: false };

                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${user.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${user.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status ${user.online ? 'online' : ''}">
                                    ${user.online ? 'üü¢ ŸÖÿ™ÿµŸÑ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            ${currentRoomId && user.online ?
                        `<button class="btn-invite" onclick="sendInviteToFriend('${fid}', '${user.name}')" title="ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®">üéÆ</button>`
                        : ''}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Render requests
        function renderRequests(requests) {
            const container = document.getElementById('requests-list');
            const requestIds = Object.keys(requests);

            if (requestIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿµÿØÿßŸÇÿ©</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const rid of requestIds) {
                const req = requests[rid];
                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${req.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${req.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status">Ÿäÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ™ŸÉ</div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-accept" onclick="acceptFriendRequest('${rid}', '${req.name}')">‚úì</button>
                            <button class="btn-reject" onclick="rejectFriendRequest('${rid}')">‚úï</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Sidebar controls
        function openFriendsSidebar() {
            // ÿπÿ±ÿ∂ ŸÖÿπÿ±ŸëŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            document.getElementById('my-user-id').textContent = myUserId;

            document.getElementById('friends-sidebar').classList.add('open');
            document.getElementById('sidebar-overlay').classList.add('show');
            renderFriendsList();
        }

        function closeFriendsSidebar() {
            document.getElementById('friends-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('show');
        }

        document.getElementById('friends-toggle').onclick = openFriendsSidebar;
        document.getElementById('close-sidebar').onclick = closeFriendsSidebar;
        document.getElementById('sidebar-overlay').onclick = closeFriendsSidebar;

        // Tab switching
        document.querySelectorAll('.friends-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const tabName = tab.dataset.tab;
                document.getElementById('friends-list').style.display = tabName === 'friends' ? 'block' : 'none';
                document.getElementById('requests-list').style.display = tabName === 'requests' ? 'block' : 'none';
                document.getElementById('my-id-section').style.display = tabName === 'add' ? 'block' : 'none';
                document.getElementById('add-friend-section').style.display = tabName === 'add' ? 'flex' : 'none';

                if (tabName === 'friends') renderFriendsList();
            };
        });

        // Copy my ID
        document.getElementById('copy-my-id').onclick = () => {
            navigator.clipboard.writeText(myUserId);
            showToast('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸëŸÅ!');
        };

        // Display my ID
        document.getElementById('my-user-id').textContent = myUserId;

        // Send friend request button
        document.getElementById('send-friend-request').onclick = () => {
            const friendId = document.getElementById('friend-id-input').value.trim();
            sendFriendRequest(friendId);
        };

        // Initialize invites listener
        listenForInvites();
        listenForFriendRequests();

        // Update user when creating/joining room
        // Update user when creating/joining room
        const originalCreateRoom = createRoom;
        createRoom = async (name, mode) => {
            initializeUser(name);
            const code = await originalCreateRoom(name, mode);
            await database.ref('users/' + myUserId + '/currentRoom').set(code);
            return code;
        };

        const originalJoinRoom = joinRoom;
        joinRoom = async (code, name) => {
            initializeUser(name);
            await originalJoinRoom(code, name);
            await database.ref('users/' + myUserId + '/currentRoom').set(code);
        };

        const originalLeaveRoom = leaveRoom;
        leaveRoom = async () => {
            await originalLeaveRoom();
            await database.ref('users/' + myUserId + '/currentRoom').set(null);
        };

        // Set offline on page unload
        window.onbeforeunload = () => {
            if (currentRoomId && currentPlayerId) {
                database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).remove();
            }
            database.ref('users/' + myUserId + '/online').set(false);
        };

        // ==================== END FRIENDS SYSTEM ====================

        // ==================== CHAT SYSTEM ====================

        let currentChatId = null;
        let currentChatFriendId = null;
        let currentChatFriendName = null;
        let chatListener = null;
        let typingTimeout = null;
        let loadedMessages = new Set();

        // Generate consistent chat ID
        function getChatId(userA, userB) {
            return [userA, userB].sort().join('_');
        }

        // Open chat with friend
        function openChat(friendId, friendName) {
            currentChatFriendId = friendId;
            currentChatFriendName = friendName;
            currentChatId = getChatId(myUserId, friendId);

            // Update header
            document.getElementById('chat-friend-name').textContent = friendName;
            document.getElementById('chat-avatar').textContent = friendName?.charAt(0) || '?';

            // Clear messages and show empty state
            document.getElementById('chat-messages').innerHTML = `
                <div class="chat-empty">
                    <div>
                        <div class="icon">üí¨</div>
                        <p>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπ ${friendName}!</p>
                    </div>
                </div>
            `;
            loadedMessages.clear();

            // Show panel
            document.getElementById('chat-panel').classList.remove('hidden');

            // Close sidebar
            closeFriendsSidebar();

            // Start listening
            listenToChat();

            // Focus input
            document.getElementById('chat-input').focus();
        }

        // Close chat
        function closeChat() {
            document.getElementById('chat-panel').classList.add('hidden');

            if (chatListener && currentChatId) {
                database.ref(`chats/${currentChatId}/messages`).off('child_added', chatListener);
                chatListener = null;
            }

            currentChatId = null;
            currentChatFriendId = null;
        }

        // Listen to chat messages (real-time)
        function listenToChat() {
            if (!currentChatId) return;

            const messagesRef = database.ref(`chats/${currentChatId}/messages`);

            if (chatListener) {
                messagesRef.off('child_added', chatListener);
            }

            chatListener = messagesRef.orderByChild('timestamp').limitToLast(100).on('child_added', snap => {
                const msg = snap.val();
                const msgId = snap.key;

                if (!loadedMessages.has(msgId)) {
                    loadedMessages.add(msgId);
                    renderMessage(msg);
                }
            });

            // Listen for typing indicator
            database.ref(`chats/${currentChatId}/typing/${currentChatFriendId}`).on('value', snap => {
                const isTyping = snap.val();
                document.getElementById('chat-typing').style.display = isTyping ? 'block' : 'none';
            });
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();

            if (!text || !currentChatId) return;

            database.ref(`chats/${currentChatId}/messages`).push({
                from: myUserId,
                fromName: myUserName || 'ŸÑÿßÿπÿ®',
                text: text,
                timestamp: Date.now()
            });

            input.value = '';

            // Clear typing indicator
            database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(false);
        }

        // Render message
        function renderMessage(msg) {
            const container = document.getElementById('chat-messages');

            // Remove empty state if exists
            const emptyState = container.querySelector('.chat-empty');
            if (emptyState) emptyState.remove();

            const isMe = msg.from === myUserId;
            const time = formatTime(msg.timestamp);

            const div = document.createElement('div');
            div.className = `chat-message ${isMe ? 'me' : 'friend'}`;

            // ÿ•ÿµŸÑÿßÿ≠ XSS - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ textContent ÿ®ÿØŸÑÿßŸã ŸÖŸÜ innerHTML
            const textSpan = document.createElement('span');
            textSpan.textContent = msg.text;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'time';
            timeSpan.textContent = time;

            div.appendChild(textSpan);
            div.appendChild(timeSpan);

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Typing indicator
        function handleTyping() {
            if (!currentChatId) return;

            database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(true);

            if (typingTimeout) clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(false);
            }, 2000);
        }

        // Chat event listeners
        document.getElementById('chat-close').onclick = closeChat;

        document.getElementById('chat-send').onclick = sendMessage;

        document.getElementById('chat-input').onkeypress = (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                handleTyping();
            }
        };

        document.getElementById('chat-input').oninput = handleTyping;

        // Update renderFriendsList to include chat button
        const originalRenderFriendsList = renderFriendsList;
        renderFriendsList = async function () {
            const container = document.getElementById('friends-list');
            const friendsSnap = await database.ref(`users/${myUserId}/friends`).once('value');
            const friends = friendsSnap.val() || {};
            const friendIds = Object.keys(friends);

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ<br>ÿ£ÿ∂ŸÅ ÿ£ÿµÿØŸÇÿßÿ° ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿ∂ÿßŸÅÿ©"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const fid of friendIds) {
                const userSnap = await database.ref('users/' + fid).once('value');
                const user = userSnap.val() || { name: friends[fid].name, online: false };

                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${user.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${user.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status ${user.online ? 'online' : ''}">
                                    ${user.online ? 'üü¢ ŸÖÿ™ÿµŸÑ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-chat" onclick="openChat('${fid}', '${user.name}')" title="ÿØÿ±ÿØÿ¥ÿ©">üí¨</button>
                            ${user.online ?
                        `<button class="btn-invite" onclick="sendInviteToFriend('${fid}', '${user.name}')" title="ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®">üéÆ</button>`
                        : ''}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        };

        // ==================== END CHAT SYSTEM ====================

        // ÿ¨ÿπŸÑ ÿßŸÑÿØŸàÿßŸÑ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÜ HTML
        window.openChat = openChat;
        window.sendInviteToFriend = sendInviteToFriend;
        window.acceptFriendRequest = acceptFriendRequest;
        window.rejectFriendRequest = rejectFriendRequest;
        window.sendFriendRequest = sendFriendRequest;

        // üî¥ AI Connection Test (Debug)
        window.testAIConnection = async function () {
            const btn = document.querySelector('button[onclick="window.testAIConnection()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="btn-icon">‚è≥</span><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÅÿ≠ÿµ...</span>';
            btn.disabled = true;

            try {
                showToast('ÿ¨ÿßÿ±Ÿä ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä...', 'info');

                // Use the engine's validateWordWithWorker function
                if (!window.GameEngine || !window.GameEngine.validateWordWithWorker) {
                    throw new Error('ŸÖÿ≠ÿ±ŸÉ ÿßŸÑŸÑÿπÿ®ÿ© ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ (GameEngine.validateWordWithWorker missing)');
                }

                // Simple validation test
                const response = await window.GameEngine.validateWordWithWorker('ÿ£ÿ≥ÿØ', 'ÿ£', 'classic');

                console.log("‚úÖ AI Test Passed:", response);
                alert(`‚úÖ ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿßÿ™ÿµÿßŸÑ!\nÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${response.valid ? 'ÿµÿ≠Ÿäÿ≠' : 'ÿÆÿ∑ÿ£'} (${response.source})`);
                showToast('‚úÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÖŸÖÿ™ÿßÿ≤!', 'success');

            } catch (e) {
                console.error("‚ùå AI Test Failed:", e);
                alert(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ:\n${e.message}\n\nÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Console ŸÑŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ.`);
                showToast('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // üî¥ Game Logic Test (Debug)
        window.testGameValidation = async function () {
            const btn = document.querySelector('button[onclick="window.testGameValidation()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="btn-icon">üß†</span><span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...</span>';
            btn.disabled = true;

            try {
                showToast('ÿ¨ÿßÿ±Ÿä ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖŸÜÿ∑ŸÇ ÿßŸÑŸÑÿπÿ®ÿ©...', 'info');

                if (!window.GameEngine || !window.GameEngine.AI_VALIDATORS) {
                    throw new Error('ŸÖÿ≠ÿ±ŸÉ ÿßŸÑŸÑÿπÿ®ÿ© ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤');
                }

                // Sample Data for "B" (Ba)
                const letter = 'ÿ®';
                const answers = {
                    boyName: 'ÿ®ÿßÿ≥ŸÖ',      // ‚úÖ Correct
                    country: 'ÿ®ÿßÿ±Ÿäÿ≥',     // ‚ùå Wrong Category (City not Country)
                    animal: 'ÿ®ÿ∑ÿ©',        // ‚úÖ Correct
                    plant: 'ÿ∑ÿßŸàŸÑÿ©'        // ‚ùå Wrong Letter (Starts with Ta)
                };

                const room = { letter: letter, mode: 'classic' };

                console.log("üß† Testing Validation with:", { letter, answers });
                const result = await window.GameEngine.AI_VALIDATORS.validator(answers, letter, room);

                console.log("üß† Validation Result:", result);

                // Format output
                let msg = `ŸÜÿ™ÿßÿ¶ÿ¨ ÿßÿÆÿ™ÿ®ÿßÿ± ÿ≠ÿ±ŸÅ "${letter}":\n`;
                msg += `ÿ®ÿßÿ≥ŸÖ (ŸàŸÑÿØ): ${result.results.boyName?.valid ? '‚úÖ' : '‚ùå'}\n`;
                msg += `ÿ®ÿßÿ±Ÿäÿ≥ (ÿ®ŸÑÿßÿØ): ${result.results.country?.valid ? '‚úÖ' : '‚ùå'} (ŸÖÿ™ŸàŸÇÿπ: ÿÆÿ∑ÿ£)\n`;
                msg += `ÿ®ÿ∑ÿ© (ÿ≠ŸäŸàÿßŸÜ): ${result.results.animal?.valid ? '‚úÖ' : '‚ùå'}\n`;
                msg += `ÿ∑ÿßŸàŸÑÿ© (ŸÜÿ®ÿßÿ™): ${result.results.plant?.valid ? '‚úÖ' : '‚ùå'} (ŸÖÿ™ŸàŸÇÿπ: ÿÆÿ∑ÿ£)\n`;
                msg += `\nÿßŸÑÿ≥ŸÉŸàÿ± ÿßŸÑŸÉŸÑŸä: ${result.score}`;

                alert(msg);
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±', 'success');

            } catch (e) {
                console.error("‚ùå Logic Test Failed:", e);
                alert(`‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:\n${e.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
    </script>
    <!-- Play Again Request Modal -->
    <div id="play-again-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-icon">üîÑ</div>
            <h3 class="modal-title">ŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâÿü</h3>
            <p class="modal-message">ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ¢ÿÆÿ± Ÿäÿ±ŸäÿØ ŸÑÿπÿ® ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©!</p>
            <div class="modal-actions">
                <button class="btn btn-primary btn-accept"
                    onclick="window.GameController.acceptPlayAgain()">ŸÖŸàÿßŸÅŸÇ</button>
                <button class="btn btn-secondary btn-decline"
                    onclick="window.GameController.declinePlayAgain()">ÿ±ŸÅÿ∂</button>
            </div>
        </div>
    </div>
</body>

</html>
