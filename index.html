<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ - ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ ŸÜÿ®ÿßÿ™ ÿ¨ŸÖÿßÿØ ÿ®ŸÑÿßÿØ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-blue: #4361ee;
            --accent-purple: #7209b7;
            --accent-pink: #f72585;
            --accent-green: #06d6a0;
            --accent-red: #ef233c;
            --accent-yellow: #ffd60a;
            --accent-orange: #fb8500;
            --accent-cyan: #00b4d8;
            --accent-lime: #84cc16;
            --text-white: #ffffff;
            --text-gray: #a0a0a0;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --border-radius: 20px;
            /* Phase Colors */
            --phase-speed: #4361ee;
            --phase-accuracy: #06d6a0;
            --phase-challenge: #f72585;
            --phase-current: var(--accent-blue);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, #0f0f23 100%);
            min-height: 100vh;
            color: var(--text-white);
        }

        /* Phase-based accent colors (Header, Borders, Accents only) */
        body[data-phase="speed"] {
            --phase-current: var(--phase-speed);
        }

        body[data-phase="accuracy"] {
            --phase-current: var(--phase-accuracy);
        }

        body[data-phase="challenge"] {
            --phase-current: var(--phase-challenge);
        }

        .phase-accent {
            color: var(--phase-current);
        }

        .phase-accent-border {
            border-color: var(--phase-current);
        }

        .phase-accent-bg {
            background-color: var(--phase-current);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Welcome Screen - New Design */
        #welcome-screen {
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            gap: 25px;
            padding: 20px;
            padding-top: 40px;
        }

        .welcome-header {
            margin-bottom: 10px;
        }

        .logo {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(0 4px 20px rgba(168, 85, 247, 0.4));
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-gray);
            margin-top: 8px;
            letter-spacing: 2px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--text-white);
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Mode Selection */
        .mode-selection {
            width: 100%;
            max-width: 500px;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .mode-card {
            background: linear-gradient(145deg, rgba(88, 28, 135, 0.8), rgba(107, 33, 168, 0.6));
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-radius: 20px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .mode-card.selected {
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.4);
        }

        .mode-card.selected .mode-card-check {
            display: flex;
        }

        .mode-card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .mode-card-badge.new {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            }
        }

        .mode-card-icon {
            font-size: 3rem;
            margin: 10px 0;
        }

        .mode-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .mode-card-desc {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .mode-card-check {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            width: 25px;
            height: 25px;
            background: #22c55e;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Player Name Section */
        .player-name-section {
            width: 100%;
            max-width: 350px;
        }

        .input-group.compact {
            margin: 0;
        }

        .input-group.compact label {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .input-group.compact input {
            padding: 14px 18px;
            font-size: 1rem;
            text-align: center;
        }

        /* Welcome Actions */
        .welcome-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }

        .btn-large {
            flex: 1;
            min-width: 150px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-icon {
            font-size: 1.3rem;
        }

        /* Categories Preview - Compact */
        .categories-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            opacity: 0.8;
        }

        .category-badge {
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .logo {
                font-size: 2.2rem;
            }

            .mode-cards {
                grid-template-columns: 1fr;
            }

            .mode-card {
                padding: 15px 12px;
            }

            .mode-card-icon {
                font-size: 2.5rem;
            }

            .welcome-actions {
                flex-direction: column;
            }

            .btn-large {
                width: 100%;
            }

            .categories-preview {
                gap: 5px;
            }

            .category-badge {
                padding: 4px 8px;
                font-size: 0.65rem;
            }
        }

        /* More responsive styles */
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .letter-display,
            .timer-display {
                padding: 12px 25px;
            }

            .current-letter {
                font-size: 2.8rem;
            }

            .timer-value {
                font-size: 2.5rem;
            }

            .categories-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 8px;
            }

            .category-header {
                padding: 8px;
                font-size: 0.85rem;
            }

            .category-input {
                padding: 10px;
                font-size: 1.2rem;
            }

            .btn-stop {
                padding: 14px 35px;
                font-size: 1.2rem;
            }

            .phase-info {
                padding: 8px 15px;
            }
        }

        /* Buttons */
        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 15px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(67, 97, 238, 0.6);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--accent-red), #d90429);
            color: white;
            font-size: 1.4rem;
            padding: 18px 50px;
        }

        .btn-stop:hover {
            transform: scale(1.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Room Screen */
        #room-screen {
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .room-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 35px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .room-card h2 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.6rem;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-gray);
        }

        .input-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 1.05rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .room-code {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 5px;
            color: var(--accent-blue);
            text-align: center;
            margin: 15px 0;
        }

        /* Waiting Screen */
        #waiting-screen {
            justify-content: center;
            align-items: center;
            gap: 30px;
            text-align: center;
        }

        .waiting-animation {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .waiting-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            animation: waitingBounce 1.4s ease-in-out infinite;
        }

        .waiting-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .waiting-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes waitingBounce {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Game Screen */
        #game-screen {
            gap: 15px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px 0;
        }

        .letter-display {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            padding: 15px 35px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .letter-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .current-letter {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1;
        }

        .timer-display {
            background: var(--glass-bg);
            padding: 15px 35px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .timer-label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .timer-value {
            font-size: 3rem;
            font-weight: 900;
            color: var(--accent-yellow);
        }

        .timer-value.warning {
            color: var(--accent-orange);
        }

        .timer-value.danger {
            color: var(--accent-red);
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* Phase Info Styles */
        .phase-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid var(--phase-current);
        }

        .mode-name {
            font-size: 1rem;
            font-weight: 700;
        }

        .phase-dots {
            font-size: 1.2rem;
            letter-spacing: 4px;
            color: var(--phase-current);
        }

        /* Locked STOP button */
        .btn-stop.locked {
            background: rgba(128, 128, 128, 0.3) !important;
            color: rgba(255, 255, 255, 0.4) !important;
            cursor: not-allowed;
            border: 2px dashed rgba(255, 255, 255, 0.2) !important;
        }

        .btn-stop.locked::before {
            content: 'üîí ';
        }

        /* Categories Grid - 9 categories in 3 rows */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 10px 0;
        }

        .category-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .category-card:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .category-header {
            padding: 10px;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .category-body {
            padding: 12px;
        }

        .category-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1rem;
            text-align: center;
        }

        .category-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
        }

        .category-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-size: 1.5rem;
        }

        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        /* Category Colors */
        .cat-boy-name .category-header {
            background: var(--accent-red);
        }

        .cat-girl-name .category-header {
            background: var(--accent-pink);
        }

        .cat-vegetable .category-header {
            background: var(--accent-green);
        }

        .cat-fruit .category-header {
            background: var(--accent-lime);
        }

        .cat-object .category-header {
            background: #6c757d;
        }

        .cat-animal .category-header {
            background: var(--accent-blue);
        }

        .cat-country .category-header {
            background: var(--accent-purple);
        }

        .cat-city .category-header {
            background: var(--accent-cyan);
        }

        .cat-job .category-header {
            background: var(--accent-orange);
        }

        /* Results Screen */
        #results-screen {
            align-items: center;
            gap: 25px;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .results-title {
            font-size: 2.2rem;
            color: var(--accent-yellow);
        }

        .winner-banner {
            background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
            color: var(--primary-bg);
            padding: 18px 35px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .results-container {
            width: 100%;
            max-width: 1000px;
        }

        .player-results {
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-name {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .player-score {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-yellow);
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .answer-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
        }

        .answer-category {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 4px;
        }

        .answer-value {
            font-size: 1rem;
            font-weight: 600;
            word-break: break-word;
        }

        .answer-value.correct {
            color: var(--accent-green);
        }

        .answer-value.wrong {
            color: var(--accent-red);
        }

        .answer-points {
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* Results Screen */
        .results-container {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .player-result-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-result-card.winner {
            border-color: var(--accent-yellow);
            background: linear-gradient(180deg, rgba(255, 214, 10, 0.1), rgba(0, 0, 0, 0.3));
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-player-name {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .result-total-score {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--accent-yellow);
        }

        .answer-points.positive {
            color: var(--accent-green);
        }

        .winner-banner {
            font-size: 1.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            color: var(--accent-yellow);
            text-shadow: 0 0 20px rgba(255, 214, 10, 0.5);
        }

        .results-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            margin-top: 20px;
        }

        /* AI Verification Loading */
        .ai-loading {
            text-align: center;
            padding: 30px;
        }

        .ai-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            border-radius: 50px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .toast.error {
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Friends System */
        .friends-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4);
            transition: all 0.3s ease;
        }

        .friends-toggle:hover {
            transform: scale(1.1);
        }

        .friends-toggle .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friends-sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 320px;
            height: 100vh;
            background: rgba(22, 33, 62, 0.98);
            backdrop-filter: blur(20px);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .friends-sidebar.open {
            left: 0;
        }

        .friends-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friends-header h3 {
            font-size: 1.3rem;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .friends-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .friends-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .friends-tab.active {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
        }

        .friends-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .add-friend-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-friend-section input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
        }

        .add-friend-section button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background: var(--accent-green);
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .friend-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .friend-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .friend-name {
            font-weight: 600;
        }

        .friend-status {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .friend-status.online {
            color: var(--accent-green);
        }

        .friend-actions {
            display: flex;
            gap: 8px;
        }

        .friend-actions button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-invite {
            background: var(--accent-green);
            color: white;
        }

        .btn-invite:hover {
            transform: scale(1.1);
        }

        .btn-accept {
            background: var(--accent-green);
            color: white;
        }

        .btn-reject {
            background: var(--accent-red);
            color: white;
        }

        .my-id-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .my-id-section label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .my-id-section .user-id {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            word-break: break-all;
            margin: 8px 0;
        }

        .my-id-section button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: var(--accent-blue);
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Invite Modal */
        .invite-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .invite-modal.show {
            display: flex;
        }

        .invite-modal-content {
            background: var(--secondary-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeIn 0.3s ease;
        }

        .invite-modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .invite-modal-content p {
            color: var(--text-gray);
            margin-bottom: 20px;
        }

        .invite-modal-content .invite-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .invite-waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-gray);
            margin-top: 15px;
        }

        .invite-waiting .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-gray);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }

            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .current-letter {
                font-size: 2.5rem;
            }

            .timer-value {
                font-size: 2rem;
            }

            .friends-sidebar {
                width: 100%;
                left: -100%;
            }

            .friends-toggle {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }

            .chat-panel {
                width: 100%;
                right: 0;
                border-radius: 20px 20px 0 0;
            }
        }

        /* Chat System */
        .chat-panel {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(22, 33, 62, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
        }

        .chat-panel.hidden {
            display: none;
        }

        .chat-header {
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 700;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-message.me {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-message.friend {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-message .time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
            display: block;
        }

        .chat-typing {
            padding: 5px 15px;
            font-size: 0.8rem;
            color: var(--text-gray);
            font-style: italic;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
        }

        .chat-input-area input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
        }

        .chat-date-divider {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.75rem;
            margin: 10px 0;
        }

        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            text-align: center;
            padding: 20px;
        }

        .chat-empty .icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Chat button in friend card */
        .btn-chat {
            background: var(--accent-blue);
            color: white;
        }

        .btn-chat:hover {
            transform: scale(1.1);
        }

        .chat-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Debug Console Overlay */
        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.85);
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
            z-index: 10000;
            border-top: 2px solid #333;
            display: none;
            /* hidden by default, toggled via script or UI */
            pointer-events: none;
            /* Let clicks pass through if needed, but we might want interaction */
            pointer-events: auto;
        }

        #debug-console .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        #debug-console .log-error {
            color: #ff5555;
        }

        #debug-console .log-warn {
            color: #ffb86c;
        }

        #debug-console .log-info {
            color: #8be9fd;
        }

        #debug-console .log-time {
            color: #6272a4;
            margin-right: 5px;
        }

        #debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 10001;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0.5;
        }

        #debug-toggle:hover {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- Debug Console Elements -->
    <div id="debug-console"></div>
    <button id="debug-toggle" onclick="toggleDebugConsole()">üêû Log</button>
    <script>
        // Debug Console Logic
        (function () {
            const consoleEl = document.getElementById('debug-console');
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;

            function formatTime() {
                const now = new Date();
                return now.toLocaleTimeString() + '.' + now.getMilliseconds();
            }

            function logToOverlay(type, args) {
                if (!consoleEl) return;
                const msg = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try { return JSON.stringify(arg); } catch (e) { return String(arg); }
                    }
                    return String(arg);
                }).join(' ');

                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.innerHTML = `<span class="log-time">[${formatTime()}]</span> ${msg}`;
                consoleEl.appendChild(entry);
                consoleEl.scrollTop = consoleEl.scrollHeight;

                // Limit logs to prevent memory issues
                if (consoleEl.children.length > 200) {
                    consoleEl.removeChild(consoleEl.firstChild);
                }
            }

            console.log = function () { originalLog.apply(console, arguments); logToOverlay('info', arguments); };
            console.warn = function () { originalWarn.apply(console, arguments); logToOverlay('warn', arguments); };
            console.error = function () { originalError.apply(console, arguments); logToOverlay('error', arguments); };

            window.toggleDebugConsole = function () {
                if (consoleEl.style.display === 'none' || consoleEl.style.display === '') {
                    consoleEl.style.display = 'block';
                } else {
                    consoleEl.style.display = 'none';
                }
            };

            // Log global errors
            window.onerror = function (msg, url, line, col, error) {
                console.error(`Global Error: ${msg} at ${url}:${line}:${col}`, error);
            };

            // Log unhandled promise rejections
            window.onunhandledrejection = function (event) {
                console.error('Unhandled Promise Rejection:', event.reason);
            };

            console.log('Debug console initialized');
        })();
    </script>
    <!-- Friends Toggle Button -->
    <button class="friends-toggle" id="friends-toggle">
        üë•
        <span class="notification-badge" id="notification-badge" style="display:none;">0</span>
    </button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Friends Sidebar -->
    <div class="friends-sidebar" id="friends-sidebar">
        <div class="friends-header">
            <h3>üë• ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</h3>
            <button class="close-sidebar" id="close-sidebar">‚úï</button>
        </div>

        <div class="friends-tabs">
            <button class="friends-tab active" data-tab="friends">ÿ£ÿµÿØŸÇÿßÿ¶Ÿä</button>
            <button class="friends-tab" data-tab="requests">ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</button>
            <button class="friends-tab" data-tab="add">ÿ•ÿ∂ÿßŸÅÿ©</button>
        </div>

        <div class="friends-content">
            <!-- My ID Section (shown in Add tab) -->
            <div id="my-id-section" class="my-id-section" style="display:none;">
                <label>üÜî ŸÖÿπÿ±ŸëŸÅŸÉ ŸÑŸÑÿ£ÿµÿØŸÇÿßÿ°:</label>
                <div class="user-id" id="my-user-id"></div>
                <button id="copy-my-id">üìã ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸëŸÅ</button>
            </div>

            <!-- Add Friend Section -->
            <div id="add-friend-section" class="add-friend-section" style="display:none;">
                <input type="text" id="friend-id-input" placeholder="ŸÖÿπÿ±ŸëŸÅ ÿßŸÑÿµÿØŸäŸÇ...">
                <button id="send-friend-request">ÿ•ÿ∂ÿßŸÅÿ©</button>
            </div>

            <!-- Friends List -->
            <div id="friends-list"></div>

            <!-- Requests List -->
            <div id="requests-list" style="display:none;"></div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="invite-modal" id="invite-modal">
        <div class="invite-modal-content">
            <h3>üì© ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®!</h3>
            <p id="invite-message"></p>
            <div class="invite-buttons">
                <button class="btn btn-primary" id="accept-invite">‚úÖ ŸÇÿ®ŸàŸÑ</button>
                <button class="btn btn-secondary" id="reject-invite">‚ùå ÿ±ŸÅÿ∂</button>
            </div>
        </div>
    </div>

    <!-- Invite Waiting Modal -->
    <div class="invite-modal" id="invite-waiting-modal">
        <div class="invite-modal-content">
            <h3>üì§ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿπŸàÿ©</h3>
            <p>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ±ÿØ <span id="invited-friend-name"></span>...</p>
            <div class="invite-waiting">
                <div class="spinner"></div>
                <span id="invite-countdown">15</span> ÿ´ÿßŸÜŸäÿ© ŸÖÿ™ÿ®ŸÇŸäÿ©
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-invite">ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿØÿπŸàÿ©</button>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel hidden" id="chat-panel">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-header-avatar" id="chat-avatar">?</div>
                <span id="chat-friend-name">üí¨ ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</span>
            </div>
            <button class="chat-close" id="chat-close">‚úï</button>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="chat-empty">
                <div>
                    <div class="icon">üí¨</div>
                    <p>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©!</p>
                </div>
            </div>
        </div>

        <div class="chat-typing" id="chat-typing" style="display:none;">
            ŸäŸÉÿ™ÿ®...
        </div>

        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." maxlength="500">
            <button class="chat-send-btn" id="chat-send">‚û§</button>
        </div>
    </div>

    <div class="container">
        <!-- Welcome Screen - New Design -->
        <div id="welcome-screen" class="screen active">
            <!-- Header -->
            <div class="welcome-header">
                <h1 class="logo">üé≤ ÿ™ÿ≠ÿØŸä ÿßŸÑÿ≠ÿ±ŸàŸÅ</h1>
                <p class="subtitle">ÿßÿ≥ŸÖ ¬∑ ÿ≠ŸäŸàÿßŸÜ ¬∑ ŸÜÿ®ÿßÿ™ ¬∑ ÿ¨ŸÖÿßÿØ ¬∑ ÿ®ŸÑÿßÿØ</p>
            </div>

            <!-- Mode Selection Cards -->
            <div class="mode-selection">
                <h2 class="section-title">üéÆ ÿßÿÆÿ™ÿ± ŸÜŸÖÿ∑ ÿßŸÑŸÑÿπÿ®</h2>
                <div class="mode-cards">
                    <!-- Classic Mode Card -->
                    <div class="mode-card selected" data-mode="classic" onclick="selectMode('classic')">
                        <div class="mode-card-badge">ŸÉŸÑÿßÿ≥ŸäŸÉŸä</div>
                        <div class="mode-card-icon">üéØ</div>
                        <div class="mode-card-title">1 ÿ∂ÿØ 1</div>
                        <div class="mode-card-desc">60 ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ©</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>

                    <!-- Multi-Phase Mode Card -->
                    <div class="mode-card" data-mode="multiphase" onclick="selectMode('multiphase')">
                        <div class="mode-card-badge new">ÿ¨ÿØŸäÿØ ‚≠ê</div>
                        <div class="mode-card-icon">‚ö°</div>
                        <div class="mode-card-title">ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ</div>
                        <div class="mode-card-desc">ÿ≥ÿ±ÿπÿ© + ÿØŸÇÿ© + ÿ™ÿ≠ÿØŸä</div>
                        <div class="mode-card-check">‚úì</div>
                    </div>
                </div>
            </div>

            <!-- Player Name Input -->
            <div class="player-name-section">
                <div class="input-group compact">
                    <label>üë§ ÿßÿ≥ŸÖŸÉ</label>
                    <input type="text" id="player-name-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="welcome-actions">
                <button class="btn btn-primary btn-large" id="create-room-btn">
                    <span class="btn-icon">‚ûï</span>
                    <span>ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©</span>
                </button>
                <button class="btn btn-secondary btn-large" id="join-room-btn">
                    <span class="btn-icon">üö™</span>
                    <span>ÿßŸÜÿ∂ŸÖÿßŸÖ ÿ®ŸÉŸàÿØ</span>
                </button>
            </div>

            <!-- Categories Preview -->
            <div class="categories-preview">
                <span class="category-badge" style="background:var(--accent-red)">ŸàŸÑÿØ</span>
                <span class="category-badge" style="background:var(--accent-pink)">ÿ®ŸÜÿ™</span>
                <span class="category-badge" style="background:var(--accent-green)">ÿÆÿ∂ÿßÿ±</span>
                <span class="category-badge" style="background:var(--accent-lime)">ŸÅŸàÿßŸÉŸá</span>
                <span class="category-badge" style="background:#6c757d">ÿ¨ŸÖÿßÿØ</span>
                <span class="category-badge" style="background:var(--accent-blue)">ÿ≠ŸäŸàÿßŸÜ</span>
                <span class="category-badge" style="background:var(--accent-purple)">ÿ®ŸÑÿßÿØ</span>
                <span class="category-badge" style="background:var(--accent-cyan)">ŸÖÿØŸäŸÜÿ©</span>
                <span class="category-badge" style="background:var(--accent-orange)">ŸÖŸáŸÜÿ©</span>
            </div>
        </div>

        <!-- Room Screen -->
        <div id="room-screen" class="screen">
            <button class="btn btn-secondary" id="back-to-welcome" style="align-self:flex-start;">‚Üí ÿßŸÑÿ±ÿ¨Ÿàÿπ</button>
            <div class="room-card" id="create-room-card" style="display:none;">
                <h2>üéÆ ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©</h2>
                <div class="input-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®</label>
                    <input type="text" id="create-player-name" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
                <button class="btn btn-primary" id="confirm-create-room" style="width:100%;">ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
                <div id="created-room-info" style="display:none;margin-top:20px;">
                    <p style="text-align:center;color:var(--text-gray);">ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©:</p>
                    <div class="room-code" id="room-code-display"></div>
                    <button class="btn btn-secondary" id="copy-room-code" style="width:100%;margin-top:10px;">üìã ŸÜÿ≥ÿÆ
                        ÿßŸÑŸÉŸàÿØ</button>
                </div>
            </div>
            <div class="room-card" id="join-room-card" style="display:none;">
                <h2>üö™ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ∫ÿ±ŸÅÿ©</h2>
                <div class="input-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®</label>
                    <input type="text" id="join-player-name" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ..." maxlength="20">
                </div>
                <div class="input-group">
                    <label>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©</label>
                    <input type="text" id="room-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ..." maxlength="6"
                        style="text-transform:uppercase;letter-spacing:3px;text-align:center;">
                </div>
                <button class="btn btn-primary" id="confirm-join-room" style="width:100%;">ÿßŸÜÿ∂ŸÖÿßŸÖ</button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div id="waiting-screen" class="screen">
            <h2>‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ¢ÿÆÿ±...</h2>
            <div class="waiting-animation">
                <div class="waiting-dot"></div>
                <div class="waiting-dot"></div>
                <div class="waiting-dot"></div>
            </div>
            <p>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©: <span id="waiting-room-code" style="color:var(--accent-blue);font-weight:700;"></span></p>
            <p id="players-count">ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ: 1/2</p>
            <button class="btn btn-secondary" id="leave-room-btn">ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="letter-display">
                    <div class="letter-label">ÿßŸÑÿ≠ÿ±ŸÅ</div>
                    <div class="current-letter phase-accent-border" id="current-letter">ÿ£</div>
                </div>
                <div id="phase-info" class="phase-info" style="display:none;">
                    <span class="mode-name phase-accent"></span>
                    <span class="phase-dots"></span>
                </div>
                <div class="timer-display">
                    <div class="timer-label">ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                    <div class="timer-value" id="timer-value">60</div>
                </div>
            </div>
            <div class="categories-grid" id="categories-container"></div>
            <div class="game-actions">
                <button class="btn btn-stop" id="stop-btn">üõë STOP</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2 class="results-title">üèÜ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</h2>
            <div class="winner-banner" id="winner-banner"></div>
            <div class="results-container" id="results-container"></div>
            <div class="results-actions">
                <button class="btn btn-primary" id="play-again-btn">üîÑ ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button>
                <button class="btn btn-secondary" id="exit-game-btn">üö™ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAwdE4U_ycmvpPhUt1qh4IUGxB1bJgh5as",
            authDomain: "word-game-7451f.firebaseapp.com",
            databaseURL: "https://word-game-7451f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "word-game-7451f",
            storageBucket: "word-game-7451f.firebasestorage.app",
            messagingSenderId: "824692932627",
            appId: "1:824692932627:web:9250e379d5455a85ce3fe6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
        // ÿßÿ≥ÿ™ÿÆÿØŸÖ Cloudflare Worker ŸÑŸÑŸÜÿ¥ÿ± ÿπŸÑŸâ GitHub Pages
        const WORKER_URL = "https://shiny-term-8522.ahanfouf9.workers.dev";

        // ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑ (ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ÿπŸÜÿØ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Worker)
        const GEMINI_API_KEY = "";

        // Game Variables
        let currentRoomId = null, currentPlayerId = null, playerName = '', isHost = false;
        let gameTimerInterval = null, currentTimeLeft = 60;
        let currentRoundId = 0; // ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑŸÑÿ™ÿ≤ÿßŸÖŸÜ
        let currentPhase = null; // ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© (speed/accuracy/null ŸÑŸÑŸÉŸÑÿßÿ≥ŸäŸÉŸä)
        let currentPhaseIndex = 0; // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
        let roomListener = null; // ÿ≠ŸÅÿ∏ ŸÖÿ±ÿ¨ÿπ ÿßŸÑŸÄ listener ŸÑÿ•ÿ≤ÿßŸÑÿ™Ÿá ŸÑÿßÿ≠ŸÇÿßŸã
        let lastInviteTime = 0; // Rate limit ÿπŸÑŸâ ÿßŸÑÿØÿπŸàÿßÿ™
        const INVITE_COOLDOWN = 5000; // 5 ÿ´ŸàÿßŸÜŸä ÿ®ŸäŸÜ ÿßŸÑÿØÿπŸàÿßÿ™
        let currentPhaseStartAt = 0; // ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÑŸÑŸÄ anti-cheat Ÿà timer

        // ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖŸàÿØÿßÿ™ ŸàÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ
        const MODES = {
            classic: {
                name: 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä',
                phases: ['accuracy'],
                durations: { accuracy: 60 }
            },
            multiphase: {
                name: 'ŸÖÿ™ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ',
                phases: ['speed', 'accuracy', 'challenge'],
                durations: { speed: 20, accuracy: 30, challenge: 10 }
            }
        };

        // Categories Definition
        const categories = [
            { id: 'boyName', label: 'ÿßÿ≥ŸÖ ŸàŸÑÿØ', class: 'cat-boy-name', prompt: 'ÿßÿ≥ŸÖ ŸàŸÑÿØ (ÿ∞ŸÉÿ±)' },
            { id: 'girlName', label: 'ÿßÿ≥ŸÖ ÿ®ŸÜÿ™', class: 'cat-girl-name', prompt: 'ÿßÿ≥ŸÖ ÿ®ŸÜÿ™ (ÿ£ŸÜÿ´Ÿâ)' },
            { id: 'vegetable', label: 'ÿÆÿ∂ÿßÿ±', class: 'cat-vegetable', prompt: 'ŸÜŸàÿπ ÿÆÿ∂ÿßÿ±' },
            { id: 'fruit', label: 'ŸÅŸàÿßŸÉŸá', class: 'cat-fruit', prompt: 'ŸÜŸàÿπ ŸÅÿßŸÉŸáÿ©' },
            { id: 'object', label: 'ÿ¨ŸÖÿßÿØ', class: 'cat-object', prompt: 'ÿ¨ŸÖÿßÿØ (ÿ¥Ÿäÿ° ÿ∫Ÿäÿ± ÿ≠Ÿä)' },
            { id: 'animal', label: 'ÿ≠ŸäŸàÿßŸÜ', class: 'cat-animal', prompt: 'ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ' },
            { id: 'country', label: 'ÿ®ŸÑÿßÿØ', class: 'cat-country', prompt: 'ÿßÿ≥ŸÖ ÿØŸàŸÑÿ©/ÿ®ŸÑÿØ' },
            { id: 'city', label: 'ŸÖÿØŸäŸÜÿ©', class: 'cat-city', prompt: 'ÿßÿ≥ŸÖ ŸÖÿØŸäŸÜÿ©' },
            { id: 'job', label: 'ŸÖŸáŸÜÿ©', class: 'cat-job', prompt: 'ÿßÿ≥ŸÖ ŸÖŸáŸÜÿ©/Ÿàÿ∏ŸäŸÅÿ©' }
        ];

        // ÿßŸÑÿ≠ÿ±ŸàŸÅ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© - ÿ•ÿ≤ÿßŸÑÿ© 'ÿ£' ŸÑÿ£ŸÜŸáÿß ÿ™ŸèÿπÿßŸÖŸÑ ŸÖÿ´ŸÑ 'ÿß'
        const arabicLetters = ['ÿß', 'ÿ®', 'ÿ™', 'ÿ´', 'ÿ¨', 'ÿ≠', 'ÿÆ', 'ÿØ', 'ÿ∞', 'ÿ±', 'ÿ≤', 'ÿ≥', 'ÿ¥', 'ÿµ', 'ÿ∂', 'ÿ∑', 'ÿ∏', 'ÿπ', 'ÿ∫', 'ŸÅ', 'ŸÇ', 'ŸÉ', 'ŸÑ', 'ŸÖ', 'ŸÜ', 'Ÿá', 'Ÿà', 'Ÿä'];

        // Initialize categories UI
        function initCategoriesUI() {
            const container = document.getElementById('categories-container');
            container.innerHTML = categories.map(cat => `
                <div class="category-card ${cat.class}">
                    <div class="category-header">${cat.label}</div>
                    <div class="category-body">
                        <input type="text" class="category-input" id="input-${cat.id}" placeholder="ÿü" autocomplete="off">
                    </div>
                </div>
            `).join('');
        }
        initCategoriesUI();

        // Helper Functions
        const screens = { welcome: document.getElementById('welcome-screen'), room: document.getElementById('room-screen'), waiting: document.getElementById('waiting-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen') };

        function showScreen(name) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[name].classList.add('active'); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }
        function generateRoomCode() { const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let r = ''; for (let i = 0; i < 6; i++) r += c[Math.floor(Math.random() * c.length)]; return r; }
        function generatePlayerId() { return 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6); }
        function getRandomLetter() { return arabicLetters[Math.floor(Math.random() * arabicLetters.length)]; }

        // Mode selection
        let selectedMode = 'classic';

        function selectMode(mode) {
            console.log('User selected mode:', mode); // Debug log
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.mode === mode);
            });
        }

        // Phase helpers
        function getPhaseLabel(phase) {
            const labels = {
                'speed': 'ÿßŸÑÿ≥ÿ±ÿπÿ© ‚ö°',
                'accuracy': 'ÿßŸÑÿØŸÇÿ© üéØ',
                'challenge': 'ÿßŸÑÿ™ÿ≠ÿØŸä üî•'
            };
            return labels[phase] || 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä';
        }

        function generateProgressDots(currentIndex, total) {
            let dots = '';
            for (let i = 0; i < total; i++) {
                dots += i <= currentIndex ? '‚óè' : '‚óã';
                if (i < total - 1) dots += ' ';
            }
            return dots;
        }

        function normalizeArabic(letter) {
            const n = { 'ÿ£': 'ÿß', 'ÿ•': 'ÿß', 'ÿ¢': 'ÿß', 'ÿ©': 'Ÿá', 'Ÿâ': 'Ÿä' };
            return n[letter] || letter;
        }

        function getFirstLetter(word) {
            if (!word || !word.trim()) return '';
            let w = word.trim();
            if (w.startsWith('ÿßŸÑ') && w.length > 2) w = w.substring(2);
            return normalizeArabic(w.charAt(0));
        }

        // AI Verification with Gemini
        async function verifyWithAI(answers, letter) {
            const results = {};
            let totalScore = 0;

            // ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑÿ∑ŸàŸÑ ÿßŸÑŸÉŸÑŸÖÿ© (ÿ≠ÿ±ŸÅŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ)
            const MIN_WORD_LENGTH = 2;

            // ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä - Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ®ÿØÿ£ ÿßŸÑŸÉŸÑŸÖÿ© ÿ®ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑÿµÿ≠Ÿäÿ≠
            function basicValidation(answer, letter) {
                const trimmed = answer.trim();
                if (trimmed.length < MIN_WORD_LENGTH) return false;
                const firstLetter = getFirstLetter(trimmed);
                const targetLetter = normalizeArabic(letter);
                return firstLetter === targetLetter;
            }

            // ÿ™ÿ≠ÿØŸäÿØ ŸÖÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸäŸàÿ¨ÿØ Ÿàÿ≥ŸäŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
            const hasWorker = WORKER_URL && WORKER_URL.trim() !== "";
            const hasApiKey = GEMINI_API_KEY && GEMINI_API_KEY.trim() !== "";

            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ Worker ÿ£Ÿà API Keyÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
            if (!hasWorker && !hasApiKey) {
                categories.forEach(cat => {
                    const answer = answers[cat.id] || '';
                    const isValid = basicValidation(answer, letter);
                    results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                    totalScore += isValid ? 10 : 0;
                });
                return { score: totalScore, results };
            }

            // Build strict prompt for Gemini
            const prompt = `ÿ£ŸÜÿ™ ŸÖÿØŸÇŸÇ ÿµÿßÿ±ŸÖ ŸÑŸÑÿ∫ÿßŸäÿ© ŸÑÿπÿ®ÿ© "ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ ŸÜÿ®ÿßÿ™ ÿ¨ŸÖÿßÿØ ÿ®ŸÑÿßÿØ". 
ÿßŸÑÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸáŸà: "${letter}"

‚ö†Ô∏è ŸÇŸàÿßÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿµÿßÿ±ŸÖÿ© ÿ¨ÿØÿßŸã - ÿßÿ™ÿ®ÿπŸáÿß ÿ®ÿØŸÇÿ©:

1. ‚úÖ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ®ÿØÿ£ ÿßŸÑŸÉŸÑŸÖÿ© ÿ®ÿßŸÑÿ≠ÿ±ŸÅ "${letter}" ÿ®ÿßŸÑÿ∂ÿ®ÿ∑ (ŸÖÿπ ŸÖÿ±ÿßÿπÿßÿ© ÿ£ŸÜ ÿ£/ÿ•/ÿ¢ = ÿßÿå Ÿàÿ™ÿ¨ÿßŸáŸÑ "ÿßŸÑ" ÿßŸÑÿ™ÿπÿ±ŸäŸÅ ŸÅŸÇÿ∑)
2. ‚úÖ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑŸÉŸÑŸÖÿ© ÿ≠ŸÇŸäŸÇŸäÿ© ŸàŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
3. ‚úÖ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑŸÉŸÑŸÖÿ© ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÑŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ®ÿßŸÑÿ∂ÿ®ÿ∑:
   - ÿßÿ≥ŸÖ ŸàŸÑÿØ: ÿßÿ≥ŸÖ ÿ∞ŸÉÿ± ÿ≠ŸÇŸäŸÇŸä (ÿ£ÿ≠ŸÖÿØÿå ŸÖÿ≠ŸÖÿØÿå ÿπŸÑŸäÿå ÿπŸÖÿ±...)
   - ÿßÿ≥ŸÖ ÿ®ŸÜÿ™: ÿßÿ≥ŸÖ ÿ£ŸÜÿ´Ÿâ ÿ≠ŸÇŸäŸÇŸä (ŸÅÿßÿ∑ŸÖÿ©ÿå ŸÖÿ±ŸäŸÖÿå ÿ≥ÿßÿ±ÿ©ÿå ŸáŸÜÿØ...)
   - ÿÆÿ∂ÿßÿ±: ŸÜŸàÿπ ÿÆÿ∂ÿßÿ± ŸÅŸÇÿ∑ (ÿÆŸäÿßÿ±ÿå ÿ∑ŸÖÿßÿ∑ŸÖÿå ÿ®ÿµŸÑÿå ÿ¨ÿ≤ÿ±...) - ŸÑŸäÿ≥ ÿßÿ≥ŸÖ ÿ£Ÿà ŸÅÿßŸÉŸáÿ©
   - ŸÅŸàÿßŸÉŸá: ŸÜŸàÿπ ŸÅÿßŸÉŸáÿ© ŸÅŸÇÿ∑ (ÿ™ŸÅÿßÿ≠ÿå ŸÖŸàÿ≤ÿå ÿ®ÿ±ÿ™ŸÇÿßŸÑ...) - ŸÑŸäÿ≥ ÿÆÿ∂ÿßÿ±
   - ÿ¨ŸÖÿßÿØ: ÿ¥Ÿäÿ° ÿ∫Ÿäÿ± ÿ≠Ÿä ŸÖŸÑŸÖŸàÿ≥ (ŸÉÿ±ÿ≥Ÿäÿå ÿ∑ÿßŸàŸÑÿ©ÿå ŸÇŸÑŸÖ...)
   - ÿ≠ŸäŸàÿßŸÜ: ÿßÿ≥ŸÖ ÿ≠ŸäŸàÿßŸÜ ÿ≠ŸÇŸäŸÇŸä (ÿ£ÿ≥ÿØÿå ŸÅŸäŸÑÿå ŸÇÿ∑ÿ©ÿå ŸÉŸÑÿ®...)
   - ÿ®ŸÑÿßÿØ: ÿßÿ≥ŸÖ ÿØŸàŸÑÿ© ÿ≠ŸÇŸäŸÇŸäÿ© (ŸÖÿµÿ±ÿå ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©ÿå ŸÑÿ®ŸÜÿßŸÜ...)
   - ŸÖÿØŸäŸÜÿ©: ÿßÿ≥ŸÖ ŸÖÿØŸäŸÜÿ© ÿ≠ŸÇŸäŸÇŸäÿ© (ÿßŸÑŸÇÿßŸáÿ±ÿ©ÿå ÿØÿ®Ÿäÿå ÿπŸÖÿßŸÜ...)
   - ŸÖŸáŸÜÿ©: ÿßÿ≥ŸÖ ŸÖŸáŸÜÿ©/Ÿàÿ∏ŸäŸÅÿ© (ÿ∑ÿ®Ÿäÿ®ÿå ŸÖŸáŸÜÿØÿ≥ÿå ŸÖÿπŸÑŸÖ...)

‚ùå ÿ£ÿπÿ∑ false ÿ•ÿ∞ÿß:
- ÿßŸÑŸÉŸÑŸÖÿ© ŸÑÿß ÿ™ÿ®ÿØÿ£ ÿ®ÿßŸÑÿ≠ÿ±ŸÅ ${letter}
- ÿßŸÑŸÉŸÑŸÖÿ© ŸÑÿß ÿ™ŸÜÿ™ŸÖŸä ŸÑŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® (ŸÖÿ´ŸÑÿßŸã: ÿßÿ≥ŸÖ ŸÅŸä ÿÆÿßŸÜÿ© ÿÆÿ∂ÿßÿ±)
- ÿßŸÑŸÉŸÑŸÖÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
- ÿßŸÑŸÉŸÑŸÖÿ© ÿ≠ÿ±ŸÅ Ÿàÿßÿ≠ÿØ ÿ£Ÿà ÿ≠ÿ±ŸàŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©

ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ:
${categories.map(cat => `- ${cat.prompt}: "${answers[cat.id] || 'ŸÅÿßÿ±ÿ∫'}"`).join('\n')}

ÿ£ÿ¨ÿ® ÿ®ŸÄ JSON ŸÅŸÇÿ∑:
{"boyName":{"valid":true/false},"girlName":{"valid":true/false},"vegetable":{"valid":true/false},"fruit":{"valid":true/false},"object":{"valid":true/false},"animal":{"valid":true/false},"country":{"valid":true/false},"city":{"valid":true/false},"job":{"valid":true/false}}`;

            try {
                let response;
                let text = '';

                if (hasWorker) {
                    response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    const data = await response.json();

                    // Worker Ÿäÿ±ÿ¨ÿπ ÿßŸÑŸÜÿµ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ£Ÿà ŸÅŸä candidates
                    if (data.candidates) {
                        text = data.candidates[0]?.content?.parts?.[0]?.text || '';
                    } else if (data.text) {
                        text = data.text;
                    } else if (typeof data === 'string') {
                        text = data;
                    } else {
                        text = JSON.stringify(data);
                    }
                } else {
                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.1 }
                        })
                    });
                    const data = await response.json();
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                }

                const jsonMatch = text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const aiResults = JSON.parse(jsonMatch[0]);

                    categories.forEach(cat => {
                        const answer = answers[cat.id] || '';
                        const trimmedAnswer = answer.trim();
                        const meetsMinLength = trimmedAnswer.length >= MIN_WORD_LENGTH;
                        const startsWithCorrectLetter = basicValidation(answer, letter);
                        const aiSaysValid = aiResults[cat.id]?.valid === true;
                        const isValid = meetsMinLength && startsWithCorrectLetter && aiSaysValid;
                        results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                        totalScore += isValid ? 10 : 0;
                    });
                    return { score: totalScore, results };
                }
            } catch (error) {
                console.error('AI verification error:', error.message);
            }

            // Fallback to basic verification
            categories.forEach(cat => {
                const answer = answers[cat.id] || '';
                const isValid = basicValidation(answer, letter);
                results[cat.id] = { answer, valid: isValid, points: isValid ? 10 : 0 };
                totalScore += isValid ? 10 : 0;
            });
            return { score: totalScore, results };
        }

        // Firebase Functions
        async function createRoom(name, mode = 'classic') {
            console.log(`Creating room for ${name} with mode: ${mode}`); // Debug log
            const code = generateRoomCode();
            currentPlayerId = generatePlayerId();
            playerName = name; isHost = true;
            currentRoundId = 0;
            currentPhase = null;
            currentPhaseIndex = 0;

            // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖŸàÿØ
            const modeConfig = MODES[mode] || MODES.classic;
            console.log('Mode Config:', modeConfig); // Debug log

            await database.ref('rooms/' + code).set({
                code,
                status: 'waiting',
                mode: mode,
                modeName: modeConfig.name,
                letter: '',
                roundId: 0,
                // ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ
                phases: modeConfig.phases,
                phaseIndex: 0,
                totalPhases: modeConfig.phases.length,
                phase: null,
                phaseStartAt: null,
                phaseDuration: 60,
                stoppedBy: '',
                stopLock: false,
                roundResults: null,
                players: { [currentPlayerId]: { name, isHost: true, answers: {}, totalScore: 0, phaseScores: {} } }
            });
            currentRoomId = code;
            setupPresence();
            return code;
        }

        async function joinRoom(code, name) {
            const snap = await database.ref('rooms/' + code).once('value');
            if (!snap.exists()) throw new Error('ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
            const room = snap.val();
            if (room.status !== 'waiting') throw new Error('ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿØÿ£ÿ™');
            if (Object.keys(room.players || {}).length >= 2) throw new Error('ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸÖÿ™ŸÑÿ¶ÿ©');
            currentPlayerId = generatePlayerId();
            playerName = name; isHost = false;
            currentRoundId = room.roundId || 0;
            currentPhase = room.phase || null;
            currentPhaseIndex = room.phaseIndex || 0;
            await database.ref(`rooms/${code}/players/${currentPlayerId}`).set({ name, isHost: false, answers: {}, totalScore: 0, phaseScores: {} });
            currentRoomId = code;
            setupPresence();
        }

        // ÿ™ÿ™ÿ®ÿπ ÿßŸÜŸÇÿ∑ÿßÿπ ÿßÿ™ÿµÿßŸÑ ÿßŸÑŸÑÿßÿπÿ®
        function setupPresence() {
            if (!currentRoomId || !currentPlayerId) return;
            const playerRef = database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`);
            playerRef.onDisconnect().remove();
        }

        async function startGame() {
            if (!currentRoomId || !isHost) return;

            // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸàÿØ ŸÖŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ©
            const roomSnap = await database.ref('rooms/' + currentRoomId).once('value');
            const room = roomSnap.val();
            console.log('startGame: Retrieved room data:', room); // Debug log

            const mode = room.mode || 'classic';
            console.log(`startGame: Starting with mode ${mode}`); // Debug log

            const modeConfig = MODES[mode] || MODES.classic;

            const newRoundId = (room.roundId || 0) + 1;
            currentRoundId = newRoundId;

            // ÿ®ÿØÿ° ŸÖŸÜ ÿ£ŸàŸÑ ŸÖÿ±ÿ≠ŸÑÿ©
            const firstPhase = modeConfig.phases[0];
            const duration = modeConfig.durations[firstPhase] || 60;

            await database.ref('rooms/' + currentRoomId).update({
                status: 'playing',
                letter: getRandomLetter(),
                roundId: newRoundId,
                phases: modeConfig.phases,
                phaseIndex: 0,
                totalPhases: modeConfig.phases.length,
                phase: firstPhase,
                phaseStartAt: firebase.database.ServerValue.TIMESTAMP,
                phaseDuration: duration,
                stoppedBy: '',
                stopLock: false,
                roundResults: null
            });
        }

        function getAnswers() {
            const answers = {};
            categories.forEach(cat => { answers[cat.id] = document.getElementById('input-' + cat.id)?.value?.trim() || ''; });
            return answers;
        }

        async function submitAnswers() {
            if (!currentRoomId || !currentPlayerId) return;
            await database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}/answers`).set(getAnswers());
        }

        async function pressStop() {
            if (!currentRoomId) return;

            // Guard: STOP ŸÅŸÇÿ∑ ŸÅŸä ŸÖÿ±ÿ≠ŸÑÿ© accuracy
            // speed = ŸÖÿÆŸÅŸäÿå challenge = ŸÖŸÇŸÅŸÑ
            if (currentPhase && currentPhase !== 'accuracy') {
                if (currentPhase === 'speed') {
                    showToast('STOP ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ ŸÅŸä ŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ≥ÿ±ÿπÿ©', 'error');
                } else if (currentPhase === 'challenge') {
                    showToast('STOP ŸÖŸÇŸÅŸÑ ŸÅŸä ŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸä', 'error');
                }
                return;
            }

            // Anti-cheat: ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ STOP ŸÇÿ®ŸÑ 5 ÿ´ŸàÿßŸÜŸä
            if (currentPhaseStartAt > 0) {
                const elapsed = (Date.now() - currentPhaseStartAt) / 1000;
                if (elapsed < 5) {
                    showToast('ÿßŸÜÿ™ÿ∏ÿ± ' + Math.ceil(5 - elapsed) + ' ÿ´ŸàÿßŸÜŸä', 'error');
                    return;
                }
            }

            // ÿ£ŸàŸÑÿßŸã: ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™
            await submitAnswers();

            // ÿ´ÿßŸÜŸäÿßŸã: ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸàŸÑÿ© ŸÖÿπ ŸÇŸÅŸÑ (transaction)
            const roomRef = database.ref('rooms/' + currentRoomId);

            try {
                await roomRef.transaction((room) => {
                    if (!room) return room;

                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ŸàÿßŸÑŸÇŸÅŸÑ
                    if (room.status !== 'playing' || room.stopLock) {
                        return; // ÿ£ÿ≠ÿØ ÿ≥ÿ®ŸÇŸÉ
                    }

                    room.status = 'finished';
                    room.stoppedBy = playerName;
                    room.stopLock = true;

                    return room;
                });
            } catch (e) {
                // ÿ¥ÿÆÿµ ÿ¢ÿÆÿ± ÿ∂ÿ∫ÿ∑ STOP ÿ£ŸàŸÑÿßŸã
            }
        }

        function cleanup() {
            if (gameTimerInterval) { clearInterval(gameTimerInterval); gameTimerInterval = null; }
            if (roomListener && currentRoomId) {
                database.ref('rooms/' + currentRoomId).off('value', roomListener);
                roomListener = null;
            }
            currentRoomId = null; currentPlayerId = null; isHost = false;
            currentRoundId = 0;
            currentPhase = null;
            currentPhaseStartAt = 0;
            lastDisplayedRoundId = 0;
        }

        async function leaveRoom() {
            if (!currentRoomId || !currentPlayerId) {
                cleanup();
                showScreen('welcome');
                return;
            }

            const roomRef = database.ref('rooms/' + currentRoomId);

            try {
                if (isHost) {
                    // ŸÜŸÇŸÑ ÿßŸÑÿßÿ≥ÿ™ÿ∂ÿßŸÅÿ© ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ¢ÿÆÿ± ÿ£Ÿà ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                    await roomRef.transaction((room) => {
                        if (!room) return room;

                        // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑŸÖÿ∂ŸäŸÅ
                        if (room.players && room.players[currentPlayerId]) {
                            delete room.players[currentPlayerId];
                        }

                        const remainingPlayers = Object.keys(room.players || {});

                        if (remainingPlayers.length === 0) {
                            // ŸÑÿß ŸäŸàÿ¨ÿØ ŸÑÿßÿπÿ®ŸàŸÜ ÿ¢ÿÆÿ±ŸàŸÜ - ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                            return null;
                        } else {
                            // ŸÜŸÇŸÑ ÿßŸÑÿßÿ≥ÿ™ÿ∂ÿßŸÅÿ© ŸÑŸÑÿßÿπÿ® ÿßŸÑÿ£ŸàŸÑ
                            const newHostId = remainingPlayers[0];
                            room.players[newHostId].isHost = true;
                            room.status = 'waiting'; // ÿ•ÿπÿßÿØÿ© ŸÑŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
                            return room;
                        }
                    });
                } else {
                    // ŸÖÿ¨ÿ±ÿØ ÿ∂ŸäŸÅ - ÿ≠ÿ∞ŸÅ ŸÜŸÅÿ≥Ÿá ŸÅŸÇÿ∑
                    await database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).remove();
                }
            } catch (e) {
                // ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
            }

            cleanup();
            showScreen('welcome');
        }

        // Timer - Ÿäÿπÿ™ŸÖÿØ ÿπŸÑŸâ ŸàŸÇÿ™ ÿßŸÑÿÆÿßÿØŸÖ ŸÑŸÑÿ™ÿ≤ÿßŸÖŸÜ
        function startTimer(roundStartAt, duration) {
            if (gameTimerInterval) clearInterval(gameTimerInterval);

            const timerEl = document.getElementById('timer-value');

            function updateTimer() {
                const now = Date.now();
                const elapsed = Math.floor((now - roundStartAt) / 1000);
                const remaining = Math.max(0, duration - elapsed);

                currentTimeLeft = remaining;
                timerEl.textContent = remaining;

                // ÿ™ŸÑŸàŸäŸÜ
                if (remaining <= 10) timerEl.className = 'timer-value danger';
                else if (remaining <= 20) timerEl.className = 'timer-value warning';
                else timerEl.className = 'timer-value';

                // ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™
                if (remaining <= 0) {
                    clearInterval(gameTimerInterval);
                    gameTimerInterval = null;
                    handleTimeUp();
                }
            }

            updateTimer(); // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸàÿ±Ÿä
            gameTimerInterval = setInterval(updateTimer, 1000);
        }

        async function handleTimeUp() {
            await submitAnswers();

            // ŸÅŸÇÿ∑ ÿßŸÑŸÖÿ∂ŸäŸÅ Ÿäÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ
            if (isHost) {
                const roomRef = database.ref('rooms/' + currentRoomId);
                const roomSnap = await roomRef.once('value');
                const room = roomSnap.val();

                if (!room || room.stopLock) return;

                const phases = room.phases || ['accuracy'];
                const currentIdx = room.phaseIndex || 0;
                const isLastPhase = currentIdx >= phases.length - 1;

                if (isLastPhase) {
                    // ÿ¢ÿÆÿ± ŸÖÿ±ÿ≠ŸÑÿ© - ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ¨ŸàŸÑÿ©
                    await roomRef.transaction((r) => {
                        if (!r || r.stopLock) return r;
                        r.status = 'finished';
                        r.stoppedBy = 'ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™';
                        r.stopLock = true;
                        return r;
                    });
                } else {
                    // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©
                    await nextPhase();
                }
            }
        }

        // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© (Ÿäÿ≥ÿ™ÿØÿπŸäŸáÿß ÿßŸÑŸÖÿ∂ŸäŸÅ ŸÅŸÇÿ∑)
        async function nextPhase() {
            if (!currentRoomId || !isHost) return;

            const roomRef = database.ref('rooms/' + currentRoomId);

            try {
                await roomRef.transaction((room) => {
                    if (!room) return room;

                    const phases = room.phases || ['accuracy'];
                    const currentIdx = room.phaseIndex || 0;
                    const nextIdx = currentIdx + 1;

                    // guard
                    if (nextIdx >= phases.length) return room;

                    const nextPhaseName = phases[nextIdx];
                    const modeConfig = MODES[room.mode] || MODES.classic;
                    const duration = modeConfig.durations[nextPhaseName] || 60;

                    room.phaseIndex = nextIdx;
                    room.phase = nextPhaseName;
                    room.phaseStartAt = firebase.database.ServerValue.TIMESTAMP;
                    room.phaseDuration = duration;
                    room.stopLock = false; // ÿ•ÿπÿßÿØÿ© ŸÅÿ™ÿ≠ STOP ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©

                    return room;
                });
            } catch (e) {
                console.error('Error transitioning phase:', e);
            }
        }

        // Room Listener
        let resultsShown = false;

        function listenToRoom() {
            // ÿ≠ŸÅÿ∏ ŸÖÿ±ÿ¨ÿπ ÿßŸÑŸÄ listener ŸÑÿ•ÿ≤ÿßŸÑÿ™Ÿá ŸÑÿßÿ≠ŸÇÿßŸã
            roomListener = database.ref('rooms/' + currentRoomId).on('value', async snap => {
                if (!snap.exists()) {
                    showToast('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©', 'error');
                    cleanup();
                    showScreen('welcome');
                    return;
                }

                const room = snap.val();
                const roomRoundId = room.roundId || 0;
                const roomPhaseIndex = room.phaseIndex || 0;

                // ÿ™ÿ≠ÿØŸäÿ´ data-phase ÿπŸÑŸâ body ŸÑŸÑÿ£ŸÑŸàÿßŸÜ
                document.body.setAttribute('data-phase', room.phase || '');

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ∂ŸäŸÅ
                const myPlayerData = room.players?.[currentPlayerId];
                if (myPlayerData && myPlayerData.isHost && !isHost) {
                    isHost = true;
                    showToast('ÿ£ÿµÿ®ÿ≠ÿ™ ÿßŸÑŸÖÿ∂ŸäŸÅ ÿßŸÑÿ¨ÿØŸäÿØ! üëë');
                }

                // ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ© - ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                if (roomRoundId > currentRoundId) {
                    currentRoundId = roomRoundId;
                    currentPhase = room.phase || null;
                    currentPhaseIndex = 0;
                    resultsShown = false;
                }

                // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿØÿßÿÆŸÑ ŸÜŸÅÿ≥ ÿßŸÑÿ¨ŸàŸÑÿ©
                if (roomPhaseIndex !== currentPhaseIndex && room.status === 'playing') {
                    currentPhaseIndex = roomPhaseIndex;
                    currentPhase = room.phase || null;
                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ§ŸÇÿ™ ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
                    if (gameTimerInterval) {
                        clearInterval(gameTimerInterval);
                        gameTimerInterval = null;
                    }
                    showToast(`üîÑ ŸÖÿ±ÿ≠ŸÑÿ© ${getPhaseLabel(room.phase)}`);
                }

                const count = Object.keys(room.players || {}).length;
                const countEl = document.getElementById('players-count');
                if (countEl) countEl.textContent = `ÿßŸÑŸÑÿßÿπÿ®ŸàŸÜ: ${count}/2`;

                // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≠ÿßŸÑÿßÿ™
                switch (room.status) {
                    case 'waiting':
                        resultsShown = false;
                        if (count === 2 && isHost) {
                            setTimeout(() => startGame(), 1000);
                        }
                        break;

                    case 'playing':
                        showGameScreen(room);
                        break;

                    case 'finished':
                        if (!resultsShown) {
                            resultsShown = true;
                            await submitAnswers();
                            // ÿßŸÜÿ™ÿ∏ÿ± ŸÇŸÑŸäŸÑÿßŸã ŸÑÿ∂ŸÖÿßŸÜ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™
                            await new Promise(resolve => setTimeout(resolve, 800));
                            // ÿ•ÿπÿßÿØÿ© ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿ´ÿ©
                            const freshSnap = await database.ref('rooms/' + currentRoomId).once('value');
                            if (freshSnap.exists()) {
                                await showResultsScreen(freshSnap.val());
                            }
                        }
                        break;

                    case 'results':
                        // ÿ≠ÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ (ÿ®ÿπÿØ ÿ≠ŸÅÿ∏Ÿáÿß ŸÖŸÜ ÿßŸÑŸÖÿ∂ŸäŸÅ)
                        if (!resultsShown) {
                            resultsShown = true;
                            await showResultsScreen(room);
                        }
                        break;
                }
            });
        }

        // ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿ™ÿ®ÿπ ÿ¢ÿÆÿ± ÿ¨ŸàŸÑÿ© ÿ™ŸÖ ÿπÿ±ÿ∂Ÿáÿß (ÿ®ÿØŸÑÿßŸã ŸÖŸÜ gameStarted)
        let lastDisplayedRoundId = 0;

        function showGameScreen(room) {
            showScreen('game');
            document.getElementById('current-letter').textContent = room.letter;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
            currentPhase = room.phase || null;
            currentPhaseIndex = room.phaseIndex || 0;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàÿØ ŸàÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©
            const phaseInfo = document.getElementById('phase-info');
            if (phaseInfo) {
                const totalPhases = room.totalPhases || 1;
                if (totalPhases > 1) {
                    const dots = generateProgressDots(room.phaseIndex || 0, totalPhases);
                    phaseInfo.innerHTML = `
                        <span class="mode-name phase-accent">${room.modeName || MODES[room.mode]?.name || 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä'}</span>
                        <span class="phase-dots">${dots}</span>
                    `;
                    phaseInfo.style.display = 'flex';
                } else {
                    phaseInfo.style.display = 'none';
                }
            }

            // ÿ£ÿπÿØ ÿ∂ÿ®ÿ∑ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©
            const roomRoundId = room.roundId || 0;
            if (roomRoundId > lastDisplayedRoundId) {
                lastDisplayedRoundId = roomRoundId;
                document.querySelectorAll('.category-input').forEach(inp => {
                    inp.disabled = false;
                    inp.value = '';
                });
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≤ÿ± STOP ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©
            const stopBtn = document.getElementById('stop-btn');
            if (room.phase === 'speed') {
                // Speed: ŸÖÿÆŸÅŸä
                stopBtn.style.display = 'none';
            } else if (room.phase === 'challenge') {
                // Challenge: ŸÖŸÇŸÅŸÑ
                stopBtn.style.display = 'block';
                stopBtn.disabled = true;
                stopBtn.classList.add('locked');
            } else {
                // Accuracy ÿ£Ÿà ŸÉŸÑÿßÿ≥ŸäŸÉŸä: ÿ∏ÿßŸáÿ± ŸàŸÖŸÅÿπŸÑ
                stopBtn.style.display = 'block';
                stopBtn.disabled = false;
                stopBtn.classList.remove('locked');
            }

            // ÿ≠ŸÅÿ∏ ŸàŸÇÿ™ ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÑŸÑŸÄ anti-cheat
            if (room.phaseStartAt) {
                currentPhaseStartAt = room.phaseStartAt;
            }

            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸàŸÇÿ™ ÿßŸÑÿÆÿßÿØŸÖ ŸÑŸÑŸÖÿ§ŸÇÿ™
            if (!gameTimerInterval && room.phaseStartAt) {
                startTimer(room.phaseStartAt, room.phaseDuration || 60);
            }
        }

        async function showResultsScreen(room) {
            if (gameTimerInterval) { clearInterval(gameTimerInterval); gameTimerInterval = null; }
            document.querySelectorAll('.category-input').forEach(inp => inp.disabled = true);
            document.getElementById('stop-btn').disabled = true;
            showScreen('results');

            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="ai-loading"><div class="ai-loading-spinner"></div><p>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™...</p></div>';

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ≠ŸÅŸàÿ∏ÿ©
            let roundResults = room.roundResults;

            if (!roundResults && isHost) {
                // ÿßŸÑŸÖÿ∂ŸäŸÅ ŸäŸÜŸÅÿ∞ AI ŸàŸäÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                roundResults = {};
                const letter = room.letter;

                for (const [pid, pdata] of Object.entries(room.players || {})) {
                    const { score, results: ansResults } = await verifyWithAI(pdata.answers || {}, letter);
                    roundResults[pid] = { score, answers: ansResults };
                }

                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸÅŸä Firebase
                await database.ref(`rooms/${currentRoomId}/roundResults`).set(roundResults);
                await database.ref(`rooms/${currentRoomId}/status`).set('results');

            } else if (!roundResults) {
                // ÿßŸÑÿ∂ŸäŸÅ ŸäŸÜÿ™ÿ∏ÿ± ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖÿ∂ŸäŸÅ
                container.innerHTML = '<div class="ai-loading"><div class="ai-loading-spinner"></div><p>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ™ÿ≠ŸÇŸÇ...</p></div>';

                // ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                return new Promise((resolve) => {
                    const resultsListener = database.ref(`rooms/${currentRoomId}/roundResults`).on('value', (snap) => {
                        if (snap.val()) {
                            database.ref(`rooms/${currentRoomId}/roundResults`).off('value', resultsListener);
                            displayResults(room, snap.val());
                            resolve();
                        }
                    });

                    // timeout ÿ®ÿπÿØ 30 ÿ´ÿßŸÜŸäÿ©
                    setTimeout(() => {
                        database.ref(`rooms/${currentRoomId}/roundResults`).off('value', resultsListener);
                        container.innerHTML = '<p>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ</p>';
                        resolve();
                    }, 30000);
                });
            }

            displayResults(room, roundResults);
        }

        function displayResults(room, roundResults) {
            const container = document.getElementById('results-container');
            const results = [];

            for (const [pid, pdata] of Object.entries(room.players || {})) {
                const playerResults = roundResults?.[pid] || { score: 0, answers: {} };
                results.push({
                    id: pid,
                    name: pdata.name,
                    score: playerResults.score,
                    answers: playerResults.answers,
                    isMe: pid === currentPlayerId
                });
            }

            results.sort((a, b) => b.score - a.score);

            const banner = document.getElementById('winner-banner');
            if (results.length >= 2) {
                if (results[0].score > results[1].score) {
                    banner.textContent = `üéâ ÿßŸÑŸÅÿßÿ¶ÿ≤: ${results[0].name} ÿ®ŸÄ ${results[0].score} ŸÜŸÇÿ∑ÿ©!`;
                    banner.style.display = 'block';
                } else if (results[0].score === results[1].score) {
                    banner.textContent = 'ü§ù ÿ™ÿπÿßÿØŸÑ!';
                    banner.style.display = 'block';
                } else {
                    banner.style.display = 'none';
                }
            } else {
                banner.style.display = 'none';
            }

            container.innerHTML = results.map(p => `
                <div class="player-results" style="${p.isMe ? 'border-color:var(--accent-blue);' : ''}">
                    <div class="player-header">
                        <span class="player-name">${p.isMe ? 'üë§ ' : ''}${p.name}</span>
                        <span class="player-score">${p.score} ŸÜŸÇÿ∑ÿ©</span>
                    </div>
                    <div class="answers-grid">
                        ${categories.map(cat => {
                const a = p.answers[cat.id] || { answer: '-', valid: false, points: 0 };
                return `<div class="answer-item">
                                <div class="answer-category">${cat.label}</div>
                                <div class="answer-value ${a.valid ? 'correct' : 'wrong'}">${a.answer || '-'}</div>
                                <div class="answer-points ${a.points > 0 ? 'positive' : ''}">${a.points > 0 ? '+10' : '0'}</div>
                            </div>`;
            }).join('')}
                    </div>
                </div>
            `).join('');

            if (room.stoppedBy) showToast(`${room.stoppedBy} ÿ£ŸÜŸáŸâ ÿßŸÑÿ¨ŸàŸÑÿ©!`);
        }

        async function playAgain() {
            // ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÉŸÑÿß ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ ÿ®ÿ®ÿØÿ° ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©
            const roomRef = database.ref('rooms/' + currentRoomId);
            const roomSnap = await roomRef.once('value');
            const room = roomSnap.val();

            if (!room) {
                showToast('ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©', 'error');
                return;
            }

            // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸàÿØ ŸÖŸÜ ÿßŸÑÿ∫ÿ±ŸÅÿ©
            const mode = room.mode || 'classic';
            const modeConfig = MODES[mode] || MODES.classic;
            const firstPhase = modeConfig.phases[0];
            const duration = modeConfig.durations[firstPhase] || 60;

            try {
                await roomRef.transaction((r) => {
                    if (!r) return r;

                    const newRoundId = (r.roundId || 0) + 1;

                    r.status = 'playing';
                    r.roundId = newRoundId;
                    r.letter = getRandomLetter();
                    r.phases = modeConfig.phases;
                    r.phaseIndex = 0;
                    r.totalPhases = modeConfig.phases.length;
                    r.phase = firstPhase;
                    r.phaseStartAt = firebase.database.ServerValue.TIMESTAMP;
                    r.phaseDuration = duration;
                    r.stoppedBy = '';
                    r.stopLock = false;
                    r.roundResults = null;

                    // ŸÖÿ≥ÿ≠ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÑŸÉŸÑ ŸÑÿßÿπÿ®
                    for (const pid in r.players) {
                        r.players[pid].answers = {};
                    }

                    return r;
                });

                // ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                resultsShown = false;

            } catch (e) {
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£', 'error');
            }
        }

        // Event Listeners - New Design
        document.getElementById('create-room-btn').onclick = async () => {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error'); return; }
            try {
                const code = await createRoom(name, selectedMode);
                document.getElementById('waiting-room-code').textContent = code;
                showScreen('waiting');
                listenToRoom();
                showToast(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©! üéÆ ÿßŸÑŸÖŸàÿØ: ${MODES[selectedMode]?.name || 'ŸÉŸÑÿßÿ≥ŸäŸÉŸä'}`);
            } catch (e) { showToast('ÿÆÿ∑ÿ£: ' + e.message, 'error'); }
        };

        document.getElementById('join-room-btn').onclick = () => {
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error'); return; }
            // Show join modal
            const code = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©:');
            if (code && code.trim()) {
                joinRoomWithCode(name, code.trim().toUpperCase());
            }
        };

        async function joinRoomWithCode(name, code) {
            try {
                await joinRoom(code, name);
                document.getElementById('waiting-room-code').textContent = code;
                showScreen('waiting');
                listenToRoom();
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ! üö™');
            } catch (e) { showToast(e.message, 'error'); }
        }

        // Old handlers for room screen (keep for compatibility)
        document.getElementById('back-to-welcome').onclick = () => showScreen('welcome');

        document.getElementById('confirm-create-room').onclick = async () => {
            const name = document.getElementById('create-player-name').value.trim();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ', 'error'); return; }
            try {
                const code = await createRoom(name, selectedMode);
                document.getElementById('room-code-display').textContent = code;
                document.getElementById('created-room-info').style.display = 'block';
                document.getElementById('waiting-room-code').textContent = code;
                showScreen('waiting');
                listenToRoom();
                showToast('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©!');
            } catch (e) { showToast('ÿÆÿ∑ÿ£: ' + e.message, 'error'); }
        };

        document.getElementById('copy-room-code').onclick = () => { navigator.clipboard.writeText(document.getElementById('room-code-display').textContent); showToast('ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!'); };

        document.getElementById('confirm-join-room').onclick = async () => {
            const name = document.getElementById('join-player-name').value.trim();
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!name) { showToast('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ', 'error'); return; }
            if (!code) { showToast('ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©', 'error'); return; }
            try {
                await joinRoom(code, name);
                document.getElementById('waiting-room-code').textContent = code;
                showScreen('waiting');
                listenToRoom();
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ!');
            } catch (e) { showToast(e.message, 'error'); }
        };

        document.getElementById('leave-room-btn').onclick = async () => { await leaveRoom(); showScreen('welcome'); };
        document.getElementById('stop-btn').onclick = pressStop;
        document.getElementById('play-again-btn').onclick = playAgain;
        document.getElementById('exit-game-btn').onclick = async () => { await leaveRoom(); showScreen('welcome'); };

        // ==================== FRIENDS SYSTEM ====================

        // User ID Management - ÿØÿßÿ¶ŸÖÿßŸã ŸÖŸàÿ¨ŸàÿØ
        let myUserId = localStorage.getItem('wordGameUserId');
        if (!myUserId) {
            myUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
            localStorage.setItem('wordGameUserId', myUserId);
        }

        let myUserName = localStorage.getItem('wordGameUserName') || '';
        let currentInvite = null;
        let inviteTimeout = null;
        let inviteCountdownInterval = null;
        let userInitialized = false;

        // Initialize user in Firebase - ŸäŸèŸÜÿ¥ÿ¶/ŸäŸèÿ≠ÿØŸëÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        function initializeUser(name) {
            if (!name) return;
            myUserName = name;
            localStorage.setItem('wordGameUserName', name);

            console.log('Initializing user:', myUserId, name);

            database.ref('users/' + myUserId).update({
                name: name,
                online: true,
                lastSeen: Date.now()
            }).then(() => {
                console.log('User initialized in Firebase');
                userInitialized = true;
            }).catch(err => {
                console.error('Error initializing user:', err);
            });

            // Set offline on disconnect
            database.ref('users/' + myUserId + '/online').onDisconnect().set(false);
            database.ref('users/' + myUserId + '/lastSeen').onDisconnect().set(Date.now());
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿßÿ≥ŸÖ ŸÖÿ≠ŸÅŸàÿ∏ÿßŸã
        if (myUserName) {
            initializeUser(myUserName);
        }

        // ÿ∑ŸÑÿ® ÿßŸÑÿßÿ≥ŸÖ ŸÇÿ®ŸÑ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°
        function ensureUserName() {
            if (myUserName) return true;

            const name = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ŸÑŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±:');
            if (name && name.trim()) {
                initializeUser(name.trim());
                return true;
            }
            showToast('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error');
            return false;
        }

        // Listen for invites
        function listenForInvites() {
            database.ref('roomInvites/' + myUserId).on('child_added', snap => {
                const invite = snap.val();
                if (!invite || Date.now() - invite.timestamp > 20000) {
                    snap.ref.remove();
                    return;
                }
                currentInvite = { ...invite, key: snap.key };
                showInviteModal(invite);
            });
        }

        // Listen for friend requests
        function listenForFriendRequests() {
            database.ref('friendRequests/' + myUserId).on('value', snap => {
                const requests = snap.val() || {};
                const count = Object.keys(requests).length;
                updateNotificationBadge(count);
                renderRequests(requests);
            });
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Show invite modal
        function showInviteModal(invite) {
            document.getElementById('invite-message').textContent =
                `${invite.fromName} ŸäÿØÿπŸàŸÉ ŸÑŸÑÿπÿ® ŸÖÿπŸá!`;
            document.getElementById('invite-modal').classList.add('show');
        }

        // Hide invite modal
        function hideInviteModal() {
            document.getElementById('invite-modal').classList.remove('show');
            if (currentInvite) {
                database.ref(`roomInvites/${myUserId}/${currentInvite.key}`).remove();
                currentInvite = null;
            }
        }

        // Accept invite
        document.getElementById('accept-invite').onclick = async () => {
            if (!currentInvite || !currentInvite.roomId) {
                showToast('ÿßŸÑÿØÿπŸàÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©', 'error');
                hideInviteModal();
                return;
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            const inviteRoomId = currentInvite.roomId;
            const inviteKey = currentInvite.key;

            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ© Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑÿØÿπŸàÿ©
            document.getElementById('invite-modal').classList.remove('show');
            database.ref(`roomInvites/${myUserId}/${inviteKey}`).remove();
            currentInvite = null;

            // Set player name if needed
            if (!myUserName) {
                myUserName = 'ŸÑÿßÿπÿ®';
            }

            try {
                await joinRoom(inviteRoomId, myUserName);
                document.getElementById('waiting-room-code').textContent = inviteRoomId;
                showScreen('waiting');
                listenToRoom();
                showToast('ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ!');
            } catch (e) {
                showToast(e.message, 'error');
            }
        };

        // Reject invite
        document.getElementById('reject-invite').onclick = () => {
            hideInviteModal();
        };

        // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™
        async function createRoomAndInvite(friendId, friendName) {
            // ŸÖŸÜÿπ ÿßŸÑÿØÿπŸàÿßÿ™ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®
            if (currentRoomId) {
                showToast('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÑÿπÿ®', 'error');
                return;
            }

            // Rate limit - ŸÖŸÜÿπ ÿßŸÑŸÄ spam
            if (Date.now() - lastInviteTime < INVITE_COOLDOWN) {
                const waitTime = Math.ceil((INVITE_COOLDOWN - (Date.now() - lastInviteTime)) / 1000);
                showToast('ÿßŸÜÿ™ÿ∏ÿ± ' + waitTime + ' ÿ´ŸàÿßŸÜŸä', 'error');
                return;
            }
            lastInviteTime = Date.now();

            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿßÿ≥ŸÖÿå ÿßÿ∑ŸÑÿ®Ÿá
            if (!myUserName) {
                const name = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ:');
                if (!name || !name.trim()) {
                    showToast('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ ÿ£ŸàŸÑÿßŸã', 'error');
                    return;
                }
                initializeUser(name.trim());
            }

            try {
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ sidebar
                closeFriendsSidebar();

                // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©
                showToast('ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©...');
                await createRoom(myUserName);

                // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿπŸàÿ©
                await database.ref(`roomInvites/${friendId}/${Date.now()}`).set({
                    roomId: currentRoomId,
                    from: myUserId,
                    fromName: myUserName,
                    timestamp: Date.now()
                });

                // ÿπÿ±ÿ∂ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                document.getElementById('waiting-room-code').textContent = currentRoomId;
                showScreen('waiting');
                listenToRoom();

                // Show waiting modal
                document.getElementById('invited-friend-name').textContent = friendName;
                document.getElementById('invite-waiting-modal').classList.add('show');

                let countdown = 30;
                document.getElementById('invite-countdown').textContent = countdown;

                inviteCountdownInterval = setInterval(() => {
                    countdown--;
                    document.getElementById('invite-countdown').textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(inviteCountdownInterval);
                    }
                }, 1000);

                // Listen for room to become full
                const roomRef = database.ref('rooms/' + currentRoomId);
                const roomListener = roomRef.on('value', snap => {
                    const room = snap.val();
                    if (room && Object.keys(room.players || {}).length >= 2) {
                        clearTimeout(inviteTimeout);
                        clearInterval(inviteCountdownInterval);
                        document.getElementById('invite-waiting-modal').classList.remove('show');
                        roomRef.off('value', roomListener);
                        showToast('ÿßŸÜÿ∂ŸÖ ÿµÿØŸäŸÇŸÉ! üéâ');
                    }
                });

                // Timeout
                inviteTimeout = setTimeout(() => {
                    clearInterval(inviteCountdownInterval);
                    document.getElementById('invite-waiting-modal').classList.remove('show');
                    roomRef.off('value', roomListener);
                    showToast('ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸäÿØŸàŸäÿßŸã: ' + currentRoomId, 'error');
                }, 30000);

            } catch (error) {
                showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + error.message, 'error');
            }
        }

        // Send invite to friend (if already in a room)
        async function sendInviteToFriend(friendId, friendName) {
            if (!currentRoomId) {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ©
                await createRoomAndInvite(friendId, friendName);
                return;
            }

            // Send invite
            await database.ref(`roomInvites/${friendId}/${Date.now()}`).set({
                roomId: currentRoomId,
                from: myUserId,
                fromName: myUserName,
                timestamp: Date.now()
            });

            // Show waiting modal
            document.getElementById('invited-friend-name').textContent = friendName;
            document.getElementById('invite-waiting-modal').classList.add('show');

            let countdown = 15;
            document.getElementById('invite-countdown').textContent = countdown;

            inviteCountdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('invite-countdown').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(inviteCountdownInterval);
                }
            }, 1000);

            // Listen for room to become full
            const roomRef = database.ref('rooms/' + currentRoomId);
            const roomListener = roomRef.on('value', snap => {
                const room = snap.val();
                if (room && Object.keys(room.players || {}).length >= 2) {
                    // Friend joined!
                    clearTimeout(inviteTimeout);
                    clearInterval(inviteCountdownInterval);
                    document.getElementById('invite-waiting-modal').classList.remove('show');
                    roomRef.off('value', roomListener);
                    closeFriendsSidebar();
                }
            });

            // Timeout - fallback to room code
            inviteTimeout = setTimeout(() => {
                clearInterval(inviteCountdownInterval);
                document.getElementById('invite-waiting-modal').classList.remove('show');
                roomRef.off('value', roomListener);
                showToast('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ±ÿØÿå ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸäÿØŸàŸäŸãÿß', 'error');
            }, 15000);
        }

        // Cancel invite
        document.getElementById('cancel-invite').onclick = () => {
            clearTimeout(inviteTimeout);
            clearInterval(inviteCountdownInterval);
            document.getElementById('invite-waiting-modal').classList.remove('show');
        };

        // Send friend request
        async function sendFriendRequest(friendId) {
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑÿßŸã
            if (!ensureUserName()) return;

            if (!friendId || friendId === myUserId) {
                showToast('ŸÖÿπÿ±ŸëŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠', 'error');
                return;
            }

            // Check if user exists
            const userSnap = await database.ref('users/' + friendId).once('value');
            if (!userSnap.exists()) {
                showToast('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ', 'error');
                return;
            }

            // Check if already friends
            const friendSnap = await database.ref(`users/${myUserId}/friends/${friendId}`).once('value');
            if (friendSnap.exists()) {
                showToast('Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿµÿØŸäŸÇŸÉ ÿ®ÿßŸÑŸÅÿπŸÑ', 'error');
                return;
            }

            // Send request
            await database.ref(`friendRequests/${friendId}/${myUserId}`).set({
                name: myUserName || 'ŸÑÿßÿπÿ®',
                timestamp: Date.now()
            });

            showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©!');
            document.getElementById('friend-id-input').value = '';
        }

        // Accept friend request
        async function acceptFriendRequest(fromUserId, fromName) {
            // Add to both users' friends list
            await database.ref(`users/${myUserId}/friends/${fromUserId}`).set({
                name: fromName,
                addedAt: Date.now()
            });
            await database.ref(`users/${fromUserId}/friends/${myUserId}`).set({
                name: myUserName || 'ŸÑÿßÿπÿ®',
                addedAt: Date.now()
            });

            // Remove request
            await database.ref(`friendRequests/${myUserId}/${fromUserId}`).remove();

            showToast(`${fromName} ÿ£ÿµÿ®ÿ≠ ÿµÿØŸäŸÇŸÉ!`);
            renderFriendsList();
        }

        // Reject friend request
        async function rejectFriendRequest(fromUserId) {
            await database.ref(`friendRequests/${myUserId}/${fromUserId}`).remove();
        }

        // Render friends list
        async function renderFriendsList() {
            const container = document.getElementById('friends-list');
            const friendsSnap = await database.ref(`users/${myUserId}/friends`).once('value');
            const friends = friendsSnap.val() || {};
            const friendIds = Object.keys(friends);

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ<br>ÿ£ÿ∂ŸÅ ÿ£ÿµÿØŸÇÿßÿ° ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿ∂ÿßŸÅÿ©"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const fid of friendIds) {
                const userSnap = await database.ref('users/' + fid).once('value');
                const user = userSnap.val() || { name: friends[fid].name, online: false };

                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${user.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${user.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status ${user.online ? 'online' : ''}">
                                    ${user.online ? 'üü¢ ŸÖÿ™ÿµŸÑ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            ${currentRoomId && user.online ?
                        `<button class="btn-invite" onclick="sendInviteToFriend('${fid}', '${user.name}')" title="ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®">üéÆ</button>`
                        : ''}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Render requests
        function renderRequests(requests) {
            const container = document.getElementById('requests-list');
            const requestIds = Object.keys(requests);

            if (requestIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿµÿØÿßŸÇÿ©</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const rid of requestIds) {
                const req = requests[rid];
                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${req.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${req.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status">Ÿäÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ™ŸÉ</div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-accept" onclick="acceptFriendRequest('${rid}', '${req.name}')">‚úì</button>
                            <button class="btn-reject" onclick="rejectFriendRequest('${rid}')">‚úï</button>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // Sidebar controls
        function openFriendsSidebar() {
            // ÿπÿ±ÿ∂ ŸÖÿπÿ±ŸëŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            document.getElementById('my-user-id').textContent = myUserId;

            document.getElementById('friends-sidebar').classList.add('open');
            document.getElementById('sidebar-overlay').classList.add('show');
            renderFriendsList();
        }

        function closeFriendsSidebar() {
            document.getElementById('friends-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('show');
        }

        document.getElementById('friends-toggle').onclick = openFriendsSidebar;
        document.getElementById('close-sidebar').onclick = closeFriendsSidebar;
        document.getElementById('sidebar-overlay').onclick = closeFriendsSidebar;

        // Tab switching
        document.querySelectorAll('.friends-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const tabName = tab.dataset.tab;
                document.getElementById('friends-list').style.display = tabName === 'friends' ? 'block' : 'none';
                document.getElementById('requests-list').style.display = tabName === 'requests' ? 'block' : 'none';
                document.getElementById('my-id-section').style.display = tabName === 'add' ? 'block' : 'none';
                document.getElementById('add-friend-section').style.display = tabName === 'add' ? 'flex' : 'none';

                if (tabName === 'friends') renderFriendsList();
            };
        });

        // Copy my ID
        document.getElementById('copy-my-id').onclick = () => {
            navigator.clipboard.writeText(myUserId);
            showToast('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÖÿπÿ±ŸëŸÅ!');
        };

        // Display my ID
        document.getElementById('my-user-id').textContent = myUserId;

        // Send friend request button
        document.getElementById('send-friend-request').onclick = () => {
            const friendId = document.getElementById('friend-id-input').value.trim();
            sendFriendRequest(friendId);
        };

        // Initialize invites listener
        listenForInvites();
        listenForFriendRequests();

        // Update user when creating/joining room
        const originalCreateRoom = createRoom;
        createRoom = async (name) => {
            initializeUser(name);
            const code = await originalCreateRoom(name);
            await database.ref('users/' + myUserId + '/currentRoom').set(code);
            return code;
        };

        const originalJoinRoom = joinRoom;
        joinRoom = async (code, name) => {
            initializeUser(name);
            await originalJoinRoom(code, name);
            await database.ref('users/' + myUserId + '/currentRoom').set(code);
        };

        const originalLeaveRoom = leaveRoom;
        leaveRoom = async () => {
            await originalLeaveRoom();
            await database.ref('users/' + myUserId + '/currentRoom').set(null);
        };

        // Set offline on page unload
        window.onbeforeunload = () => {
            if (currentRoomId && currentPlayerId) {
                database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).remove();
            }
            database.ref('users/' + myUserId + '/online').set(false);
        };

        // ==================== END FRIENDS SYSTEM ====================

        // ==================== CHAT SYSTEM ====================

        let currentChatId = null;
        let currentChatFriendId = null;
        let currentChatFriendName = null;
        let chatListener = null;
        let typingTimeout = null;
        let loadedMessages = new Set();

        // Generate consistent chat ID
        function getChatId(userA, userB) {
            return [userA, userB].sort().join('_');
        }

        // Open chat with friend
        function openChat(friendId, friendName) {
            currentChatFriendId = friendId;
            currentChatFriendName = friendName;
            currentChatId = getChatId(myUserId, friendId);

            // Update header
            document.getElementById('chat-friend-name').textContent = friendName;
            document.getElementById('chat-avatar').textContent = friendName?.charAt(0) || '?';

            // Clear messages and show empty state
            document.getElementById('chat-messages').innerHTML = `
                <div class="chat-empty">
                    <div>
                        <div class="icon">üí¨</div>
                        <p>ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ŸÖÿπ ${friendName}!</p>
                    </div>
                </div>
            `;
            loadedMessages.clear();

            // Show panel
            document.getElementById('chat-panel').classList.remove('hidden');

            // Close sidebar
            closeFriendsSidebar();

            // Start listening
            listenToChat();

            // Focus input
            document.getElementById('chat-input').focus();
        }

        // Close chat
        function closeChat() {
            document.getElementById('chat-panel').classList.add('hidden');

            if (chatListener && currentChatId) {
                database.ref(`chats/${currentChatId}/messages`).off('child_added', chatListener);
                chatListener = null;
            }

            currentChatId = null;
            currentChatFriendId = null;
        }

        // Listen to chat messages (real-time)
        function listenToChat() {
            if (!currentChatId) return;

            const messagesRef = database.ref(`chats/${currentChatId}/messages`);

            if (chatListener) {
                messagesRef.off('child_added', chatListener);
            }

            chatListener = messagesRef.orderByChild('timestamp').limitToLast(100).on('child_added', snap => {
                const msg = snap.val();
                const msgId = snap.key;

                if (!loadedMessages.has(msgId)) {
                    loadedMessages.add(msgId);
                    renderMessage(msg);
                }
            });

            // Listen for typing indicator
            database.ref(`chats/${currentChatId}/typing/${currentChatFriendId}`).on('value', snap => {
                const isTyping = snap.val();
                document.getElementById('chat-typing').style.display = isTyping ? 'block' : 'none';
            });
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();

            if (!text || !currentChatId) return;

            database.ref(`chats/${currentChatId}/messages`).push({
                from: myUserId,
                fromName: myUserName || 'ŸÑÿßÿπÿ®',
                text: text,
                timestamp: Date.now()
            });

            input.value = '';

            // Clear typing indicator
            database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(false);
        }

        // Render message
        function renderMessage(msg) {
            const container = document.getElementById('chat-messages');

            // Remove empty state if exists
            const emptyState = container.querySelector('.chat-empty');
            if (emptyState) emptyState.remove();

            const isMe = msg.from === myUserId;
            const time = formatTime(msg.timestamp);

            const div = document.createElement('div');
            div.className = `chat-message ${isMe ? 'me' : 'friend'}`;

            // ÿ•ÿµŸÑÿßÿ≠ XSS - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ textContent ÿ®ÿØŸÑÿßŸã ŸÖŸÜ innerHTML
            const textSpan = document.createElement('span');
            textSpan.textContent = msg.text;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'time';
            timeSpan.textContent = time;

            div.appendChild(textSpan);
            div.appendChild(timeSpan);

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Typing indicator
        function handleTyping() {
            if (!currentChatId) return;

            database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(true);

            if (typingTimeout) clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                database.ref(`chats/${currentChatId}/typing/${myUserId}`).set(false);
            }, 2000);
        }

        // Chat event listeners
        document.getElementById('chat-close').onclick = closeChat;

        document.getElementById('chat-send').onclick = sendMessage;

        document.getElementById('chat-input').onkeypress = (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                handleTyping();
            }
        };

        document.getElementById('chat-input').oninput = handleTyping;

        // Update renderFriendsList to include chat button
        const originalRenderFriendsList = renderFriendsList;
        renderFriendsList = async function () {
            const container = document.getElementById('friends-list');
            const friendsSnap = await database.ref(`users/${myUserId}/friends`).once('value');
            const friends = friendsSnap.val() || {};
            const friendIds = Object.keys(friends);

            if (friendIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ<br>ÿ£ÿ∂ŸÅ ÿ£ÿµÿØŸÇÿßÿ° ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ÿ•ÿ∂ÿßŸÅÿ©"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const fid of friendIds) {
                const userSnap = await database.ref('users/' + fid).once('value');
                const user = userSnap.val() || { name: friends[fid].name, online: false };

                html += `
                    <div class="friend-card">
                        <div class="friend-info">
                            <div class="friend-avatar">${user.name?.charAt(0) || '?'}</div>
                            <div>
                                <div class="friend-name">${user.name || 'ŸÑÿßÿπÿ®'}</div>
                                <div class="friend-status ${user.online ? 'online' : ''}">
                                    ${user.online ? 'üü¢ ŸÖÿ™ÿµŸÑ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                                </div>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <button class="btn-chat" onclick="openChat('${fid}', '${user.name}')" title="ÿØÿ±ÿØÿ¥ÿ©">üí¨</button>
                            ${user.online ?
                        `<button class="btn-invite" onclick="sendInviteToFriend('${fid}', '${user.name}')" title="ÿØÿπŸàÿ© ŸÑŸÑÿπÿ®">üéÆ</button>`
                        : ''}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        };

        // ==================== END CHAT SYSTEM ====================

        // ÿ¨ÿπŸÑ ÿßŸÑÿØŸàÿßŸÑ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÜ HTML
        window.openChat = openChat;
        window.sendInviteToFriend = sendInviteToFriend;
        window.acceptFriendRequest = acceptFriendRequest;
        window.rejectFriendRequest = rejectFriendRequest;
        window.sendFriendRequest = sendFriendRequest;
    </script>
</body>

</html>
